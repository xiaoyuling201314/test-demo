<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="食安科技">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>被检单位</title>
    <link rel="stylesheet" type="text/css" href="../plug-in/easyui/easyui.css">
    <link rel="stylesheet" type="text/css" href="../plug-in/easyui/icon.css">
    <link rel="stylesheet" type="text/css" href="../plug-in/easyui/tree.css">
    <link rel="stylesheet" type="text/css" href="../iconfont/iconfont.css"/>
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="../css/instrument.css"/>
</head>
<body>
<div class="top-bar is-flex">
    <div class="top-back text-left" onclick="returnBackkAndroid();">
        <a href="javascript:window.history.back();"><img src="../img/new.png" alt=""></a>
        <span>被检单位</span>
    </div>
    <div class="top-btn text-right select-type">
        <label><span class="move-name">单位类型：</span>
            <select id="regTypes" onchange="search()"></select>
        </label>
        <div class="cs-search-box cs-fr">
            <div class="cs-search-filter clearfix cs-fl">
                <input class="cs-input-cont cs-fl" id="keywords" type="text" placeholder="请输入内容">
                <input type="submit" class="cs-search-btn cs-fl" onclick="search()" value="搜索">
            </div>
        </div>
        <!--<a href="reg_add.html"><img src="../img/add.png"></a>-->
        <input type="button" id="regAdd" class="cs-search-btn cs-fl" style="border-radius: 0.25rem;display: none;"
               onclick="window.location.href='reg_add.html'" value="新增">
    </div>
</div>

<div class="content">
    <table class="table-style">
        <thead>
        <tr>
            <th style="width: 3.75rem">序号</th>
            <th class="cs-header">被检单位</th>
            <th class="cs-header" style="width: 8.75rem;">单位类型</th>
            <th class="cs-header" style="width: 6.25rem;">经营户</th>
            <!--<th class="cs-header">地址</th>-->
            <th class="cs-header" style="width: 6.25rem;">状态</th>
            <th class="cs-header" style="width: 6.25rem;">操作</th>
        </tr>
        </thead>
        <tbody id="tableData">

        </tbody>
    </table>
</div>

<div id="noData" class="no-data cs-hide">
    <img src="../img/logo.png" alt="" style="width: 60px">
    <p style="font-size:16px;margin-top: 5px;">暂无数据</p>
</div>
<div id="my-message"></div>
<!-- 内容主体 结束 -->
<!-- JavaScript -->
<script src="../js/jquery.min1.11.3.js"></script>
<script type="text/javascript" src="../plug-in/easyui/jquery.easyui.min.js"></script>
<script src="../common/js/common.js"></script>
<script>$("#my-message").load("message.html");</script>
<script type="text/javascript">
    const pageConfig = {
        pageSize: 10000,
        pageNo: 1,
        rowTotal: 0,
        pageCount: 0,
    };
    let $tableData = $("#tableData");
    let $noData = $("#noData");

    $(function () {
        regAddShow();
        getRegTypes();
        loadData();
    });


    function loadData() {
        $.ajax({
            type: "GET",
            url: "../../iRegulatory/Object/",
            data: {
                pageSize: pageConfig.pageSize,
                pageNo: pageConfig.pageNo,
                regName: $("#keywords").val(),
                regType: $("#regTypes").val(),
                userToken,
            },
            dataType: "json",
            success: ({success, msg, obj}) => {
                if (success) {
                    let html = ``;
                    for (let i = 0; i < obj.results.length; i++) {
                        let item = obj.results[i];
                        html += `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${item.regName}</td>
                                    <td>${item.regTypeName}</td>
                                    <td><a href="reg_bus_list.html?id=${item.id}&regName=${encodeURI(item.regName)}" class="text-primary text-under">${item.businessNumber}户</a></td>
                                    <td>${item.checked === 1 ? '<span>已审核</span>' : '<span class="text-danger">未审核</span>'}</td>
                                    <td><a href="reg_add.html?id=${item.id}" class="icon iconfont icon-xiugai"></a></td>
                                </tr>`;
                    }
                    $tableData.html(html);
                    html ? $noData.addClass("cs-hide") : $noData.removeClass("cs-hide");
                } else {
                    message(msg)
                }
            }
        });
    }


    function getRegTypes() {
        $.ajax({
            type: "GET",
            url: "../../iRegulatory/Object/regTypes",
            async: false,
            data: {userToken},
            dataType: "json",
            success: ({success, msg, obj}) => {
                if (success) {
                    let html = `<option value="">全部</option>`;
                    for (let i = 0; i < obj.length; i++) {
                        html += `<option value="${obj[i].id}">${obj[i].regType}</option>`
                    }
                    $("#regTypes").html(html);
                } else {
                    message(msg)
                }
            }
        });
    }

    function regAddShow() {
        $.ajax({
            type: "GET",
            url: "../../iRegulatory/Object/auth",
            async: false,
            data: {userToken},
            dataType: "json",
            success: ({success, msg, obj}) => {
                if (success) {
                    obj && $("#regAdd").show();
                } else {
                    message(msg)
                }
            }
        });
    }

    function search() {
        // pageConfig.pageSize = 10;
        // pageConfig.pageNo = 1;
        loadData();
    }
    //返回仪器界面
    function returnBackkAndroid(){
        androidObj.callByJS();
    }
</script>
<script type="text/javascript">
    /* 返回上个页面-强制页面刷新*/
    window.addEventListener('pageshow', function (event) {
        //event.persisted属性为true时，表示当前文档是从往返缓存中获取
        //window.performance.navigation.type === 2: 网页通过“前进”或“后退”按钮加载
        if (event.persisted || window.performance && window.performance.navigation.type === 2) {
            setTimeout(function () {
                loadData();//当网页是从缓存中获取时需要重新加载数据
            }, 200)
        }
    }, false);
</script>
</body>
</html>

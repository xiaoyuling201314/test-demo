<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dayuan3.common.mapper.InspectionUnitUserLabelMapper">
    <resultMap id="BaseResultMap" type="com.dayuan3.common.bean.InspectionUnitUserLabel">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Jan 03 09:21:48 CST 2020.
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="user_id" jdbcType="INTEGER" property="userId"/>
        <result column="label_name" jdbcType="VARCHAR" property="labelName"/>
        <result column="isDefault" jdbcType="SMALLINT" property="isdefault"/>
        <result column="remark" jdbcType="VARCHAR" property="remark"/>
        <result column="param1" jdbcType="VARCHAR" property="param1"/>
        <result column="param2" jdbcType="VARCHAR" property="param2"/>
        <result column="param3" jdbcType="VARCHAR" property="param3"/>
        <result column="delete_flag" jdbcType="SMALLINT" property="deleteFlag"/>
        <result column="create_by" jdbcType="VARCHAR" property="createBy"/>
        <result column="create_date" jdbcType="TIMESTAMP" property="createDate"/>
        <result column="update_by" jdbcType="VARCHAR" property="updateBy"/>
        <result column="update_date" jdbcType="TIMESTAMP" property="updateDate"/>
        <result column="label_first_letter" jdbcType="VARCHAR" property="labelFirstLetter"/>
        <result column="label_full_letter" jdbcType="VARCHAR" property="labelFullLetter"/>
        <!-- 外表字段 -->
        <result column="num" jdbcType="INTEGER" property="num"/>


    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Jan 03 09:21:48 CST 2020.
        -->
        id, user_id, label_name, isDefault, remark, param1, param2, param3, delete_flag,
        create_by, create_date, update_by, update_date, label_first_letter, label_full_letter
    </sql>

    <!-- 根据用户查询标签 -->
    <select id="selectByUserId" parameterType="Object" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>, (select COUNT(1) from inspection_unit_user_requester req WHERE req.delete_flag=0 AND
        req.label_id=label.id) as num
        from inspection_unit_user_label label
        WHERE delete_flag=0 AND user_id= #{userId,jdbcType=INTEGER}
        order by update_date desc
        <if test="rowStart !=null and rowEnd!=null">
            limit #{rowStart}, #{rowEnd}
        </if>
    </select>
    <!-- 查询用户标签 -->
    <select id="selectLabelName" parameterType="Object" resultMap="BaseResultMap">
        SELECT *
        FROM inspection_unit_user_label
        WHERE delete_flag = 0 AND user_id = #{userId,jdbcType=INTEGER} AND label_name = #{labelName}
    </select>
    <!-- 设置默认标签 -->
    <update id="updateSetDefault" parameterType="Object">
        UPDATE inspection_unit_user_label
        SET isDefault = CASE WHEN id = #{id,jdbcType=INTEGER}
            THEN 1
                        ELSE 0 END, update_date = NOW(), update_by = #{userId}
        WHERE user_id = #{userId}
    </update>
    <!-- 取消默认 -->
    <update id="updateQxDefault" parameterType="Object">
        UPDATE inspection_unit_user_label
        SET isDefault = 0, update_date = NOW(), update_by = #{userId}
        WHERE user_id = #{userId,jdbcType=INTEGER} AND id = #{id,jdbcType=INTEGER}
    </update>


    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Jan 03 09:21:48 CST 2020.
        -->
        select
        <include refid="Base_Column_List"/>
        from inspection_unit_user_label
        where id = #{id,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="Object">
        update inspection_unit_user_label set delete_flag=1,update_date=now()
        where id in
        <foreach collection="array" item="ids" index="index" open="("
                 close=")" separator=",">
            #{ids}
        </foreach>
    </delete>
    <insert id="insert" parameterType="com.dayuan3.common.bean.InspectionUnitUserLabel" useGeneratedKeys="true" keyProperty="id">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Jan 03 09:21:48 CST 2020.
        -->
        INSERT INTO inspection_unit_user_label (id, user_id, label_name,
        isDefault, remark, param1,
        param2, param3, delete_flag,
        create_by, create_date, update_by,
        update_date, label_first_letter, label_full_letter)
        VALUES (#{id,jdbcType=INTEGER}, #{userId,jdbcType=INTEGER}, #{labelName,jdbcType=VARCHAR},
        #{isdefault,jdbcType=SMALLINT}, #{remark,jdbcType=VARCHAR}, #{param1,jdbcType=VARCHAR},
        #{param2,jdbcType=VARCHAR}, #{param3,jdbcType=VARCHAR}, #{deleteFlag,jdbcType=SMALLINT},
        #{createBy,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, #{updateBy,jdbcType=VARCHAR},
        #{updateDate,jdbcType=TIMESTAMP}, #{labelFirstLetter,jdbcType=VARCHAR}, #{labelFullLetter,jdbcType=VARCHAR})
    </insert>
    <insert id="insertSelective" parameterType="com.dayuan3.common.bean.InspectionUnitUserLabel" useGeneratedKeys="true" keyProperty="id">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Jan 03 09:21:48 CST 2020.
        -->
        insert into inspection_unit_user_label
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="userId != null">
                user_id,
            </if>
            <if test="labelName != null">
                label_name,
            </if>
            <if test="isdefault != null">
                isDefault,
            </if>
            <if test="remark != null">
                remark,
            </if>
            <if test="param1 != null">
                param1,
            </if>
            <if test="param2 != null">
                param2,
            </if>
            <if test="param3 != null">
                param3,
            </if>
            <if test="deleteFlag != null">
                delete_flag,
            </if>
            <if test="createBy != null">
                create_by,
            </if>
            <if test="createDate != null">
                create_date,
            </if>
            <if test="updateBy != null">
                update_by,
            </if>
            <if test="updateDate != null">
                update_date,
            </if>
            <if test="labelFirstLetter != null">
                label_first_letter,
            </if>
            <if test="labelFullLetter != null">
                label_full_letter,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="userId != null">
                #{userId,jdbcType=INTEGER},
            </if>
            <if test="labelName != null">
                #{labelName,jdbcType=VARCHAR},
            </if>
            <if test="isdefault != null">
                #{isdefault,jdbcType=SMALLINT},
            </if>
            <if test="remark != null">
                #{remark,jdbcType=VARCHAR},
            </if>
            <if test="param1 != null">
                #{param1,jdbcType=VARCHAR},
            </if>
            <if test="param2 != null">
                #{param2,jdbcType=VARCHAR},
            </if>
            <if test="param3 != null">
                #{param3,jdbcType=VARCHAR},
            </if>
            <if test="deleteFlag != null">
                #{deleteFlag,jdbcType=SMALLINT},
            </if>
            <if test="createBy != null">
                #{createBy,jdbcType=VARCHAR},
            </if>
            <if test="createDate != null">
                #{createDate,jdbcType=TIMESTAMP},
            </if>
            <if test="updateBy != null">
                #{updateBy,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="labelFirstLetter != null">
                #{labelFirstLetter,jdbcType=VARCHAR},
            </if>
            <if test="labelFullLetter != null">
                #{labelFullLetter,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.dayuan3.common.bean.InspectionUnitUserLabel">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Jan 03 09:21:48 CST 2020.
        -->
        update inspection_unit_user_label
        <set>
            <if test="userId != null">
                user_id = #{userId,jdbcType=INTEGER},
            </if>
            <if test="labelName != null">
                label_name = #{labelName,jdbcType=VARCHAR},
            </if>
            <if test="isdefault != null">
                isDefault = #{isdefault,jdbcType=SMALLINT},
            </if>
            <if test="remark != null">
                remark = #{remark,jdbcType=VARCHAR},
            </if>
            <if test="param1 != null">
                param1 = #{param1,jdbcType=VARCHAR},
            </if>
            <if test="param2 != null">
                param2 = #{param2,jdbcType=VARCHAR},
            </if>
            <if test="param3 != null">
                param3 = #{param3,jdbcType=VARCHAR},
            </if>
            <if test="deleteFlag != null">
                delete_flag = #{deleteFlag,jdbcType=SMALLINT},
            </if>
            <if test="createBy != null">
                create_by = #{createBy,jdbcType=VARCHAR},
            </if>
            <if test="createDate != null">
                create_date = #{createDate,jdbcType=TIMESTAMP},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                update_date = #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="labelFirstLetter != null">
                label_first_letter = #{labelFirstLetter,jdbcType=VARCHAR},
            </if>
            <if test="labelFullLetter != null">
                label_full_letter = #{labelFullLetter,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.dayuan3.common.bean.InspectionUnitUserLabel">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Jan 03 09:21:48 CST 2020.
        -->
        UPDATE inspection_unit_user_label
        SET user_id = #{userId,jdbcType=INTEGER},
        label_name = #{labelName,jdbcType=VARCHAR},
        isDefault = #{isdefault,jdbcType=SMALLINT},
        remark = #{remark,jdbcType=VARCHAR},
        param1 = #{param1,jdbcType=VARCHAR},
        param2 = #{param2,jdbcType=VARCHAR},
        param3 = #{param3,jdbcType=VARCHAR},
        delete_flag = #{deleteFlag,jdbcType=SMALLINT},
        create_by = #{createBy,jdbcType=VARCHAR},
        create_date = #{createDate,jdbcType=TIMESTAMP},
        update_by = #{updateBy,jdbcType=VARCHAR},
        update_date = #{updateDate,jdbcType=TIMESTAMP},
        label_first_letter = #{labelFirstLetter,jdbcType=VARCHAR},
        label_full_letter = #{labelFullLetter,jdbcType=VARCHAR}
        WHERE id = #{id,jdbcType=INTEGER}
    </update>
    <!-- 自助终端使用 用于查询根据用户ID查询标签或生成拼音 -->
    <select id="queryAllByLastUpdateTime" parameterType="Object" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>, (select COUNT(1) from inspection_unit_user_requester req WHERE req.delete_flag=0 AND
        req.label_id=label.id) as num
        from inspection_unit_user_label label
        WHERE delete_flag=0
        <if test="lastUpdateTime !=null">
            and update_date&gt;=#{lastUpdateTime}
        </if>
        <if test="userId!=null">
            and user_id= #{userId,jdbcType=INTEGER}
            order by isDefault desc,update_date desc
        </if>
    </select>

    <!--查询该人员全部委托单位个数-->
    <select id="selectAllCountLabel" resultType="java.lang.Integer">
        SELECT count(1)
        FROM
            (
                SELECT request_id
                FROM inspection_unit_requester_unit inru
                WHERE inspection_id = #{inspId} AND delete_flag = 0
                UNION
                SELECT req.request_id
                FROM inspection_unit_user_requester req
                    JOIN inspection_unit_user_label label
                        ON req.label_id = label.id
                WHERE label.user_id = #{userId} AND req.delete_flag = 0 AND label.delete_flag = 0
            ) tab1
    </select>
    <select id="selectAllLabelList" resultType="com.dayuan3.common.bean.InspectionUnitUserRequester">
        SELECT
            ru.id AS requestId,
            ru.requester_name AS requestName,
            ru.link_phone linkPhone,ru.company_address companyAddress
        FROM requester_unit ru
            JOIN
            (
                SELECT request_id
                FROM inspection_unit_requester_unit inru
                WHERE inspection_id = #{inspId} AND delete_flag = 0
                UNION
                SELECT req.request_id
                FROM inspection_unit_user_requester req
                    JOIN inspection_unit_user_label label
                        ON req.label_id = label.id
                WHERE label.user_id = #{userId} AND req.delete_flag = 0 AND label.delete_flag = 0
            ) tab1 ON tab1.request_id = ru.id
    </select>

    <!--求得当前用户分组的总数量 shit-->
    <select id="selectLabelNum" resultType="java.lang.Integer">
        SELECT count(1) FROM inspection_unit_user_label WHERE delete_flag = 0 AND user_id = #{userId}
    </select>
</mapper>
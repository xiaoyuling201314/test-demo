<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dayuan.mapper.data.TbCheckPlanMapper">

    <resultMap id="BaseResultMap" type="com.dayuan.bean.data.TbCheckPlan">
            <id property="id" column="id" />
            <result property="weekNum" column="week_num" />
            <result property="foodId" column="food_id" />
            <result property="itemIdMon" column="item_id_mon" />
            <result property="itemIdTue" column="item_id_tue" />
            <result property="itemIdWeb" column="item_id_web" />
            <result property="itemIdThu" column="item_id_thu" />
            <result property="itemIdFri" column="item_id_fri" />
            <result property="itemIdSat" column="item_id_sat" />
            <result property="itemIdSun" column="item_id_sun" />
            <result property="deleteFlag" column="delete_flag" />
            <result property="createDate" column="create_date" />
            <result property="createBy" column="create_by" />
            <result property="updateDate" column="update_date" />
            <result property="updateBy" column="update_by" />
            <!--非数据库字段-->
            <result property="foodName" column="food_name" />
            <result property="itemName1" column="itemName1" />
            <result property="itemName2" column="itemName2" />
            <result property="itemName3" column="itemName3" />
            <result property="itemName4" column="itemName4" />
            <result property="itemName5" column="itemName5" />
            <result property="itemName6" column="itemName6" />
            <result property="itemName7" column="itemName7" />

    </resultMap>

    <sql id="Base_Column_List">
        id,week_num,food_id, -- food_name,
        item_id_mon,item_id_tue,
        item_id_web,item_id_thu,item_id_fri,item_id_sat,item_id_sun,
        delete_flag,create_date,create_by,update_date,update_by
    </sql>

    <select id="getPlans" resultType="java.util.Map">
        select t.food_id AS foodId, bdi.id AS itemId, bdi.detect_item_name AS itemName, bdi.price AS price
            from tb_check_plan t
            <choose>
                <when test="dayOfWeek == 2">
                    left join base_detect_item bdi on t.item_id_mon = bdi.id
                </when>
                <when test="dayOfWeek == 3">
                    left join base_detect_item bdi on t.item_id_tue = bdi.id
                </when>
                <when test="dayOfWeek == 4">
                    left join base_detect_item bdi on t.item_id_web = bdi.id
                </when>
                <when test="dayOfWeek == 5">
                    left join base_detect_item bdi on t.item_id_thu = bdi.id
                </when>
                <when test="dayOfWeek == 6">
                    left join base_detect_item bdi on t.item_id_fri = bdi.id
                </when>
                <when test="dayOfWeek == 7">
                    left join base_detect_item bdi on t.item_id_sat = bdi.id
                </when>
                <otherwise>
                    left join base_detect_item bdi on t.item_id_sun = bdi.id
                </otherwise>
            </choose>
        where t.food_id in
        <foreach item="item" collection="foodIds" separator="," open="(" close=")">
            #{item}
        </foreach>
            and t.delete_flag = 0 and bdi.delete_flag = 0
    </select>
    <!-- 分页基础查询 -->
    <select id="loadDatagrid" resultMap="BaseResultMap" parameterType="Object">
        select plan.id,food.id food_id,food.food_name,
        plan.item_id_mon,
        (select detect_item_name from base_detect_item where id=plan.item_id_mon) itemName1,
        plan.item_id_tue,
        (select detect_item_name from base_detect_item where id=plan.item_id_tue) itemName2,
        plan.item_id_web,
        (select detect_item_name from base_detect_item where id=plan.item_id_web) itemName3,
        plan.item_id_thu,
        (select detect_item_name from base_detect_item where id=plan.item_id_thu) itemName4,
        plan.item_id_fri,
        (select detect_item_name from base_detect_item where id=plan.item_id_fri) itemName5,
        plan.item_id_sat,
        (select detect_item_name from base_detect_item where id=plan.item_id_sat) itemName6,
        plan.item_id_sun,
        (select detect_item_name from base_detect_item where id=plan.item_id_sun) itemName7
        from base_food_type food
        left join tb_check_plan plan on food.id=plan.food_id
        <include refid="Example_Where_Clause"/>
        ORDER BY food.update_date ${order},plan.update_date ${order} LIMIT #{rowOffset}, #{pageSize}
    </select>

    <select id="getRowTotal" resultType="java.lang.Integer" parameterType="Object">
        SELECT count(1) AS rowTotal
        from base_food_type food
        left join tb_check_plan plan on food.id=plan.food_id
        <include refid="Example_Where_Clause"/>
    </select>

    <sql id="Example_Where_Clause">
        where food.delete_flag = 0 and food.isFood=1
        <if test="obj.keyWords != null and obj.keyWords != ''">
            AND (food.food_name LIKE CONCAT('%',#{obj.keyWords},'%')
            OR food.food_name_other LIKE CONCAT('%',#{obj.keyWords},'%')
            )
        </if>
    </sql>

    <select id="queryById" resultMap="BaseResultMap" parameterType="java.lang.Integer">
        select plan.id,food.id food_id,food.food_name,
        plan.item_id_mon,
        (select detect_item_name from base_detect_item where id=plan.item_id_mon) itemName1,
        plan.item_id_tue,
        (select detect_item_name from base_detect_item where id=plan.item_id_tue) itemName2,
        plan.item_id_web,
        (select detect_item_name from base_detect_item where id=plan.item_id_web) itemName3,
        plan.item_id_thu,
        (select detect_item_name from base_detect_item where id=plan.item_id_thu) itemName4,
        plan.item_id_fri,
        (select detect_item_name from base_detect_item where id=plan.item_id_fri) itemName5,
        plan.item_id_sat,
        (select detect_item_name from base_detect_item where id=plan.item_id_sat) itemName6,
        plan.item_id_sun,
        (select detect_item_name from base_detect_item where id=plan.item_id_sun) itemName7
        from base_food_type food
        left join tb_check_plan plan on food.id=plan.food_id
        where food.delete_flag = 0 and plan.id=#{id}
    </select>
</mapper>

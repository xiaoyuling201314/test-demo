<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dayuan.mapper.wx.WxsignInMapper">
    <resultMap id="BaseResultMap" type="com.dayuan.bean.wx.WxsignIn">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jul 16 09:16:11 CST 2018.
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="longitude" jdbcType="VARCHAR" property="longitude"/>
        <result column="latitude" jdbcType="VARCHAR" property="latitude"/>
        <result column="address" jdbcType="VARCHAR" property="address"/>
        <result column="sign_type" jdbcType="SMALLINT" property="signType"/>
        <result column="delete_flag" jdbcType="SMALLINT" property="deleteFlag"/>
        <result column="create_by" jdbcType="VARCHAR" property="createBy"/>
        <result column="create_date" jdbcType="TIMESTAMP" property="createDate"/>
        <result column="update_by" jdbcType="VARCHAR" property="updateBy"/>
        <result column="update_date" jdbcType="TIMESTAMP" property="updateDate"/>
        <result column="param1" jdbcType="VARCHAR" property="param1"/>
        <result column="param2" jdbcType="VARCHAR" property="param2"/>
        <result column="param3" jdbcType="VARCHAR" property="param3"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jul 16 09:16:11 CST 2018.
        -->
        id, longitude, latitude, address, sign_type, delete_flag, create_by, create_date,
        update_by, update_date, param1, param2, param3
    </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jul 16 09:16:11 CST 2018.
        -->
        select
        <include refid="Base_Column_List"/>
        from wx_sign_in
        where id = #{id,jdbcType=INTEGER}
    </select>


    <resultMap id="BaseResultModelMap" type="com.dayuan.model.wx.WxsignInModel">
        <id column="id" property="id"/>
        <result column="longitude" property="longitude" jdbcType="VARCHAR"/>
        <result column="latitude" property="latitude" jdbcType="VARCHAR"/>
        <result column="address" property="address" jdbcType="VARCHAR"/>
        <result column="createDate" property="createDate" jdbcType="TIMESTAMP"/>
        <result column="userId" property="userId" jdbcType="VARCHAR"/>
        <result column="userName" property="userName" jdbcType="VARCHAR"/>
        <result column="nickName" property="nickName" jdbcType="VARCHAR"/>
        <result column="departId" property="departId" jdbcType="INTEGER"/>
        <result column="pointId" property="pointId" jdbcType="INTEGER"/>
        <result column="departName" property="departName" jdbcType="VARCHAR"/>
        <result column="pointName" property="pointName" jdbcType="VARCHAR"/>
    </resultMap>
    <!-- 通过机构ID查询当天签到信息 -->
    <select id="queryByDepartIds" resultMap="BaseResultModelMap" parameterType="Object">
        select tsi.id id, tsi.longitude longitude, tsi.latitude latitude,
        tsi.address address, tsi.create_date createDate,
        wx.id userId,wx.user_name userName,wx.nickName nickName,
        tsd.id departId, tsd.depart_name departName,
        bp.id pointId, bp.point_name pointName
        from wx_user wx
        left join
        (SELECT a.id id, a.longitude longitude, a.latitude latitude, a.address address, a.create_date create_date, a.create_by create_by FROM (
        SELECT id, longitude, latitude, address,sign_type, create_date, create_by FROM wx_sign_in where delete_flag = 0
        AND longitude IS NOT NULL AND longitude != ''
        AND latitude IS NOT NULL AND latitude != ''
        AND create_date LIKE CONCAT(#{signDate},'%') ORDER BY create_date DESC
        )a GROUP BY a.create_by) tsi
        on tsi.create_by = wx.id
        left join t_s_depart tsd on wx.depart_id = tsd.id
        left join base_point bp on wx.point_id = bp.id
        where wx.delete_flag = 0
        <if test="nickName != null and nickName != ''">
            and wx.nickName LIKE CONCAT('%',#{nickName},'%')
        </if>
        and wx.depart_id =#{departId}
    </select>
    <!-- 通过机构ID查询所有有签到记录的日期 -->
    <select id="querySignDate" resultType="java.lang.String" parameterType="Object">
        select DISTINCT (DATE_FORMAT(tsi.create_date, '%Y-%m-%d'))
        from wx_sign_in tsi
        left join wx_user wx on tsi.create_by = wx.id
        where wx.delete_flag = 0 and tsi.delete_flag = 0
        <if test="departArr != null and departArr.length > 0">
            and wx.depart_id in
            <foreach item="item" index="index" collection="departArr" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        AND tsi.longitude IS NOT NULL AND tsi.longitude != ''
        AND tsi.latitude IS NOT NULL AND tsi.latitude != ''
    </select>
    <select id="queryByUserId" resultMap="BaseResultModelMap" parameterType="Object">
        SELECT
            tsi.id          id,
            tsi.longitude   longitude,
            tsi.latitude    latitude,
            tsi.sign_type,
            tsi.address     address,
            tsi.create_date createDate,
            tsi.param1      param1,
            tsi.param2      param2,
            wx.id           userId,
            wx.user_name    userName,
            wx.nickName     nickName,
            tsd.id          departId,
            tsd.depart_name departName,
            bp.id           pointId,
            bp.point_name   pointName
        FROM wx_sign_in tsi
            LEFT JOIN wx_user wx ON tsi.create_by = wx.id
            LEFT JOIN t_s_depart tsd ON wx.depart_id = tsd.id
            LEFT JOIN base_point bp ON wx.point_id = bp.id
        WHERE wx.delete_flag = 0 AND tsi.delete_flag = 0
              AND tsi.longitude IS NOT NULL AND tsi.longitude != ''
              AND tsi.latitude IS NOT NULL AND tsi.latitude != ''
              AND tsi.create_by = #{userId}
              AND tsi.create_date LIKE concat(#{dateStr}, '%')
        ORDER BY tsi.create_date DESC
    </select>


    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jul 16 09:16:11 CST 2018.
        -->
        DELETE FROM wx_sign_in
        WHERE id = #{id,jdbcType=INTEGER}
    </delete>
    <insert id="insert" parameterType="com.dayuan.bean.wx.WxsignIn">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jul 16 09:16:11 CST 2018.
        -->
        INSERT INTO wx_sign_in (id, longitude, latitude,
        address, sign_type, delete_flag,
        create_by, create_date, update_by,
        update_date, param1, param2,
        param3)
        VALUES (#{id,jdbcType=INTEGER}, #{longitude,jdbcType=VARCHAR}, #{latitude,jdbcType=VARCHAR},
        #{address,jdbcType=VARCHAR}, #{signType,jdbcType=SMALLINT}, #{deleteFlag,jdbcType=SMALLINT},
        #{createBy,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, #{updateBy,jdbcType=VARCHAR},
        #{updateDate,jdbcType=TIMESTAMP}, #{param1,jdbcType=VARCHAR}, #{param2,jdbcType=VARCHAR},
        #{param3,jdbcType=VARCHAR})
    </insert>
    <insert id="insertSelective" parameterType="com.dayuan.bean.wx.WxsignIn">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jul 16 09:16:11 CST 2018.
        -->
        insert into wx_sign_in
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="longitude != null">
                longitude,
            </if>
            <if test="latitude != null">
                latitude,
            </if>
            <if test="address != null">
                address,
            </if>
            <if test="signType != null">
                sign_type,
            </if>
            <if test="deleteFlag != null">
                delete_flag,
            </if>
            <if test="createBy != null">
                create_by,
            </if>
            <if test="createDate != null">
                create_date,
            </if>
            <if test="updateBy != null">
                update_by,
            </if>
            <if test="updateDate != null">
                update_date,
            </if>
            <if test="param1 != null">
                param1,
            </if>
            <if test="param2 != null">
                param2,
            </if>
            <if test="param3 != null">
                param3,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="longitude != null">
                #{longitude,jdbcType=VARCHAR},
            </if>
            <if test="latitude != null">
                #{latitude,jdbcType=VARCHAR},
            </if>
            <if test="address != null">
                #{address,jdbcType=VARCHAR},
            </if>
            <if test="signType != null">
                #{signType,jdbcType=SMALLINT},
            </if>
            <if test="deleteFlag != null">
                #{deleteFlag,jdbcType=SMALLINT},
            </if>
            <if test="createBy != null">
                #{createBy,jdbcType=VARCHAR},
            </if>
            <if test="createDate != null">
                #{createDate,jdbcType=TIMESTAMP},
            </if>
            <if test="updateBy != null">
                #{updateBy,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="param1 != null">
                #{param1,jdbcType=VARCHAR},
            </if>
            <if test="param2 != null">
                #{param2,jdbcType=VARCHAR},
            </if>
            <if test="param3 != null">
                #{param3,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.dayuan.bean.wx.WxsignIn">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jul 16 09:16:11 CST 2018.
        -->
        update wx_sign_in
        <set>
            <if test="longitude != null">
                longitude = #{longitude,jdbcType=VARCHAR},
            </if>
            <if test="latitude != null">
                latitude = #{latitude,jdbcType=VARCHAR},
            </if>
            <if test="address != null">
                address = #{address,jdbcType=VARCHAR},
            </if>
            <if test="signType != null">
                sign_type = #{signType,jdbcType=SMALLINT},
            </if>
            <if test="deleteFlag != null">
                delete_flag = #{deleteFlag,jdbcType=SMALLINT},
            </if>
            <if test="createBy != null">
                create_by = #{createBy,jdbcType=VARCHAR},
            </if>
            <if test="createDate != null">
                create_date = #{createDate,jdbcType=TIMESTAMP},
            </if>
            <if test="updateBy != null">
                update_by = #{updateBy,jdbcType=VARCHAR},
            </if>
            <if test="updateDate != null">
                update_date = #{updateDate,jdbcType=TIMESTAMP},
            </if>
            <if test="param1 != null">
                param1 = #{param1,jdbcType=VARCHAR},
            </if>
            <if test="param2 != null">
                param2 = #{param2,jdbcType=VARCHAR},
            </if>
            <if test="param3 != null">
                param3 = #{param3,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.dayuan.bean.wx.WxsignIn">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Jul 16 09:16:11 CST 2018.
        -->
        UPDATE wx_sign_in
        SET longitude = #{longitude,jdbcType=VARCHAR},
        latitude = #{latitude,jdbcType=VARCHAR},
        address = #{address,jdbcType=VARCHAR},
        sign_type = #{signType,jdbcType=SMALLINT},
        delete_flag = #{deleteFlag,jdbcType=SMALLINT},
        create_by = #{createBy,jdbcType=VARCHAR},
        create_date = #{createDate,jdbcType=TIMESTAMP},
        update_by = #{updateBy,jdbcType=VARCHAR},
        update_date = #{updateDate,jdbcType=TIMESTAMP},
        param1 = #{param1,jdbcType=VARCHAR},
        param2 = #{param2,jdbcType=VARCHAR},
        param3 = #{param3,jdbcType=VARCHAR}
        WHERE id = #{id,jdbcType=INTEGER}
    </update>

    <!--查询该人员的签到信息 shit添加-->
    <select id="selectSignIn" resultType="com.dayuan.bean.wx.WxsignIn">
        SELECT
        tsi.id,
        tsi.longitude,
        tsi.latitude,
        wu.user_name as createBy,
        tsi.create_date as createDate,
        tsi.address
        FROM wx_sign_in tsi
        JOIN wx_user wu ON wu.id = tsi.create_by
        <include refid="baseWhere"/>
        ORDER BY tsi.create_date DESC
    </select>
    <sql id="baseWhere">
        <where>
            tsi.delete_flag = 0 AND wu.status = 0 AND tsi.sign_type = 0
            <if test="startTime != null and startTime != ''">
                AND DATE_FORMAT(tsi.create_date, '%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime}, '%Y-%m-%d')
            </if>
            <if test="endTime != null and endTime != ''">
                AND DATE_FORMAT(tsi.create_date, '%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime}, '%Y-%m-%d')
            </if>
            <if test="userId != null">
                AND wu.id = #{userId}
            </if>
        </where>
    </sql>

    <select id="loadDatagrid" resultType="com.dayuan.bean.wx.WxsignIn"
            parameterType="Object">
        SELECT
        tsi.id,
        wu.nickName as param1,
        tsi.create_date AS createDate,
        tsi.address
        FROM wx_sign_in tsi
        JOIN wx_user wu ON wu.id = tsi.create_by
        WHERE tsi.delete_flag = 0 AND tsi.sign_type = 0 AND wu.status = 0
        <if test="obj.userId != null and obj.userId != ''">
            AND wu.id = #{obj.userId}
        </if>
        <if test="obj.start !=null and obj.start !='' and obj.end !=null and obj.end !=''">
            and tsi.create_date &gt;=#{obj.start} and tsi.create_date &lt;=#{obj.end}
        </if>
        ORDER BY createDate DESC
        LIMIT #{rowOffset}, #{pageSize}
    </select>


    <select id="getRowTotal" resultType="java.lang.Integer"
            parameterType="Object">
        SELECT count(1) AS rowTotal
        FROM wx_sign_in tsi
        JOIN wx_user wu ON wu.id = tsi.create_by
        WHERE tsi.delete_flag = 0 AND tsi.sign_type = 0 AND wu.status = 0
        <if test="obj.userId != null and obj.userId != ''">
            AND wu.id = #{obj.userId}
        </if>
        <if test="obj.start !=null and obj.start !='' and obj.end !=null and obj.end !=''">
            and tsi.create_date &gt;=#{obj.start} and tsi.create_date &lt;=#{obj.end}
        </if>
    </select>

    <!--查询打卡前的考勤信息-->
    <select id="selectBeforeCardSignIn" resultType="com.dayuan.bean.wx.WxsignIn">
        SELECT
            wsi.id,
            wsi.create_date AS createDate
        FROM wx_sign_in wsi
            JOIN wx_user wu ON wu.id = wsi.create_by
        WHERE wsi.delete_flag = 0 AND wsi.sign_type = 0 AND wu.status = 0 AND wu.id = #{userId}
              AND wsi.create_date LIKE CONCAT(#{dateStr}, '%') AND wsi.create_date &lt;= #{punchTime}
        LIMIT 0, 1
    </select>
</mapper>
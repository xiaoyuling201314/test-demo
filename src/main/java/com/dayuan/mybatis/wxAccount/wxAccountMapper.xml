<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dayuan.mapper.wxAccount.wxAccountMapper">
  <resultMap id="BaseResultMap" type="com.dayuan.bean.wxAccount.wxAccount">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 08 15:10:08 CST 2018.
    -->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="account_name" jdbcType="VARCHAR" property="accountName" />
    <result column="account_appid" jdbcType="VARCHAR" property="accountAppid" />
    <result column="account_appsecret" jdbcType="VARCHAR" property="accountAppsecret" />
    <result column="depart_id" jdbcType="INTEGER" property="departId" />
    <result column="account_user" jdbcType="VARCHAR" property="accountUser" />
    <result column="account_user_phone" jdbcType="VARCHAR" property="accountUserPhone" />
    <result column="account_count" jdbcType="INTEGER" property="accountCount" />
    <result column="redirect_url" jdbcType="VARCHAR" property="redirectUrl" />
    <result column="sign_name" jdbcType="VARCHAR" property="signName" />
    <result column="template_code" jdbcType="VARCHAR" property="templateCode" />
    <result column="access_keyid" jdbcType="VARCHAR" property="accessKeyid" />
    <result column="access_keysecret" jdbcType="VARCHAR" property="accessKeysecret" />
    <result column="remark" jdbcType="VARCHAR" property="remark" />
    <result column="status" jdbcType="SMALLINT" property="status" />
    <result column="delete_flag" jdbcType="SMALLINT" property="deleteFlag" />
    <result column="create_by" jdbcType="VARCHAR" property="createBy" />
    <result column="create_date" jdbcType="TIMESTAMP" property="createDate" />
    <result column="update_by" jdbcType="VARCHAR" property="updateBy" />
    <result column="update_date" jdbcType="TIMESTAMP" property="updateDate" />
    <result column="param1" jdbcType="VARCHAR" property="param1" />
    <result column="param2" jdbcType="VARCHAR" property="param2" />
    <result column="param3" jdbcType="VARCHAR" property="param3" />
       <!--外部统计字段 2018-11-16 胡  -->
	       <result column="count" jdbcType="VARCHAR" property="count" />
	        <result column="departName" jdbcType="VARCHAR" property="departName" />
	        <result column="samNum" jdbcType="INTEGER" property="samNum" />
	        <result column="samUserNum" jdbcType="INTEGER" property="samUserNum" />
	         <result column="recordingNum" jdbcType="INTEGER" property="recordingNum" />
  </resultMap>
  
    <!--    model 映射字段  -->
  <resultMap id="BaseResultMapModel" type="com.dayuan.model.wxAccount.wxAccountModel">
    <id column="id" jdbcType="INTEGER" property="id" />
    		<result column="accountAppid" jdbcType="VARCHAR" property="accountAppid" />
	       <result column="count" jdbcType="VARCHAR" property="count" />
	        <result column="samNum" jdbcType="INTEGER" property="samNum" />
	        <result column="samUserNum" jdbcType="INTEGER" property="samUserNum" />
	         <result column="recordingNum" jdbcType="INTEGER" property="recordingNum" />
	         <!-- 抽样单内容映射11-19 -->
	         <result column="account_name" jdbcType="VARCHAR" property="accountName" />
		       <result column="reg_name" jdbcType="VARCHAR" property="regName" />
		        <result column="sampling_no" jdbcType="VARCHAR" property="samplingNo" />
		        <result column="reg_link_phone" jdbcType="VARCHAR" property="regLinkPhone" />
		         <result column="samplingDate" jdbcType="TIMESTAMP" property="samplingDate" />
		         <result column="sampling_username" jdbcType="VARCHAR" property="samplingUsername" />
		         <result column="total" jdbcType="VARCHAR" property="total" />
		         <result column="completionNum" jdbcType="VARCHAR" property="completionNum" />
  </resultMap>
  
    
  
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 08 15:10:08 CST 2018.
    -->
    id, account_name, account_appid, account_appsecret, depart_id, account_user, account_user_phone, 
    account_count, redirect_url, sign_name, template_code, access_keyid, access_keysecret, 
    remark, status, delete_flag, create_by, create_date, update_by, update_date, param1, 
    param2, param3
  </sql>
  	<!-- 查询公众号送检人数 -->
		  <select id="selectSamUserNumByDepartCode" parameterType="Object" resultMap="BaseResultMapModel">
		  SELECT COUNT(1) as samUserNum,app_id as accountAppid from (
			SELECT COUNT(u.mobile_phone) , u.app_id FROM tb_sampling sam
			LEFT  JOIN wx_inspection_user u ON u.mobile_phone = sam.reg_link_phone
			WHERE  sam.delete_flag = 0  AND sam.personal = 1 and u.app_id IN (
				SELECT a.account_appid FROM wx_account a LEFT JOIN t_s_depart d ON a.depart_id = d.id
					WHERE 	a.delete_flag = 0 AND d.depart_code LIKE CONCAT(#{departCode}, '%')
					)
		GROUP BY u.app_id,mobile_phone )t GROUP BY accountAppid
		  </select>
  	<!-- 查询公众号送检数量 -->
	  <select id="selectSamNumByDepartCode" parameterType="Object" resultMap="BaseResultMapModel">
			  SELECT COUNT(u.mobile_phone) as samNum , u.app_id  as accountAppid
					FROM
				tb_sampling sam LEFT  JOIN wx_inspection_user u ON u.mobile_phone = sam.reg_link_phone
			WHERE
				sam.delete_flag = 0
				AND sam.personal = 1 and u.app_id IN ( SELECT a.account_appid FROM wx_account a LEFT JOIN t_s_depart d ON a.depart_id = d.id WHERE
					a.delete_flag = 0 AND d.depart_code LIKE CONCAT(#{departCode}, '%') )
			GROUP BY 	u.app_id;
	  </select>
  <!-- 查询公众号检测批次 -->
  <select id="selectRecordingNumByDepartCode" parameterType="Object" resultMap="BaseResultMapModel">
			SELECT COUNT(1) as recordingNum,t.app_id as accountAppid 
			FROM data_check_recording record RIGHT  JOIN 
			(SELECT  sam.id, u.app_id  FROM tb_sampling sam LEFT  JOIN wx_inspection_user u ON u.mobile_phone = sam.reg_link_phone
			WHERE sam.delete_flag = 0 AND sam.personal = 1 and u.app_id IN (
				SELECT 	a.account_appid FROM wx_account a LEFT JOIN t_s_depart d ON a.depart_id = d.id WHERE
					a.delete_flag = 0 AND d.depart_code LIKE CONCAT(#{departCode}, '%')
			)) t on record.sampling_id=t.id GROUP BY t.app_id
  </select>
  
  
  <!-- 查询条件 -->
	<sql id="Example_Where_Clause">
		where 1=1
		and wx.delete_flag=0
		<if test="obj != null">
			<if test="obj.keyWords !=null and obj.keyWords !=''">
				and account_name like CONCAT('%', #{obj.keyWords}, '%')
			</if>
			<if test="obj.departCode !=null and obj.departCode !=''">
				and depart.depart_code LIKE CONCAT(#{obj.departCode},'%')
			</if>
		</if>
	</sql>

  <!-- 加载列表数据 -->
  <select id="loadDatagrid" resultMap="BaseResultMap" parameterType="Object" >
   SELECT
	wx.*, depart_name as departName,
(SELECT COUNT(1) FROM wx_inspection_user wxuser WHERE wxuser.delete_flag=0 and wxuser.app_id=wx.account_appid)as count
FROM
	wx_account wx
LEFT JOIN t_s_depart depart ON wx.depart_id = depart.id
    <include refid="Example_Where_Clause" />
    order by create_date ${order} limit #{rowOffset}, #{pageSize}
  </select>
  
  
    <!-- 得到总条数 -->
  <select id="getRowTotal" resultType="java.lang.Integer" parameterType="Object" >
    	select count(1) as rowTotal 
 	   FROM	wx_account wx
		LEFT JOIN t_s_depart depart ON wx.depart_id = depart.id
    	<include refid="Example_Where_Clause" />
  </select>
  
  <!-- 根据公众号查询送检人 送检单列表   start -->
  
	  <!-- 根据公众号查询抽样单 -->
	    <select id="loadDatagrid2" resultMap="BaseResultMapModel" parameterType="Object" >
	 	SELECT s.id as id, wx.account_name, s.reg_name, s.sampling_no, s.reg_link_phone, s.sampling_date as samplingDate, s.sampling_username,
			( SELECT count(1) FROM tb_sampling_detail WHERE sampling_id = s.id ) AS total,
			( SELECT count(1) FROM data_check_recording WHERE sampling_id = s.id AND delete_flag = 0 ) AS completionNum
		FROM
		wx_inspection_user u
		RIGHT JOIN tb_sampling s ON u.mobile_phone = s.reg_link_phone
		LEFT JOIN wx_account wx ON u.app_id = wx.account_appid
		WHERE   s.delete_flag=0 and
			s.personal=1 and 
	  		wx.id = #{obj.id}
	  			<if test="obj.samplingNo !=null and obj.samplingNo !=''">
							and s.sampling_no=#{obj.sampling_no}
				 </if>
	  			<if test="obj.regName !=null and obj.regName !=''">
							and s.reg_name=#{obj.regName}
				 </if>
	  			<if test="obj.search !=null and obj.search !=''">
							and ( 
							s.reg_name like CONCAT('%', #{obj.search}, '%')
							or
							s.sampling_no like CONCAT('%', #{obj.search}, '%')
							)
				 </if>
	  		<if test="obj.searchType !=null and obj.searchType !=''">
				GROUP BY u.mobile_phone			
			 </if>
	    order by samplingDate ${order} limit #{rowOffset}, #{pageSize}
	  </select>
  	
  	  <!-- 得到总条数 -->
  <select id="getRowTotal2" resultType="java.lang.Integer" parameterType="Object" >
 	SELECT
	count(1) as rowTotal  from(	
		 	SELECT s.id as id  FROM
		wx_inspection_user u
		RIGHT JOIN tb_sampling s ON u.mobile_phone = s.reg_link_phone
		LEFT JOIN wx_account wx ON u.app_id = wx.account_appid
		WHERE  s.delete_flag=0 and
			s.personal=1 and 
	  		wx.id = #{obj.id}
	  			<if test="obj.samplingNo !=null and obj.samplingNo !=''">
							and s.sampling_no=#{obj.samplingNo}
				 </if>
	  			<if test="obj.regName !=null and obj.regName !=''">
							and s.reg_name=#{obj.regName}
				 </if>
	  			<if test="obj.search !=null and obj.search !=''">
							and ( 
							s.reg_name like CONCAT('%', #{obj.search}, '%')
							or
							s.sampling_no like CONCAT('%', #{obj.search}, '%')
							)
				 </if>
	  		<if test="obj.searchType !=null and obj.searchType !=''">
				GROUP BY u.mobile_phone			
			 </if>
			) t
  </select>
  <!--  根据公众号查询送检人 送检单列表 end -->
  
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
   SELECT wx.*,d.depart_name as departName,	(
		SELECT 	COUNT(1) 	FROM wx_inspection_user u WHERE u.app_id = wx.account_appid  ) AS count 
		from wx_account wx LEFT JOIN t_s_depart d on wx.depart_id=d.id
    where wx.id = #{id,jdbcType=INTEGER}
  </select>
<!--   <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 08 15:10:08 CST 2018.
   
    delete from wx_account
    where id = #{id,jdbcType=INTEGER}
  </delete> -->
  	<!-- 批量删除-逻辑删除 -->
	<update id="deleteByPrimaryKey" parameterType="Object">
		update wx_account
		set delete_flag = 1
		where id in
		<foreach collection="array" item="ids" index="index" open="("
			close=")" separator=",">
			#{ids}
		</foreach>
	</update>
  <insert id="insert" parameterType="com.dayuan.bean.wxAccount.wxAccount">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 08 15:10:08 CST 2018.
    -->
    insert into wx_account (id, account_name, account_appid, 
      account_appsecret, depart_id, account_user, 
      account_user_phone, account_count, redirect_url, 
      sign_name, template_code, access_keyid, 
      access_keysecret, remark, status, 
      delete_flag, create_by, create_date, 
      update_by, update_date, param1, 
      param2, param3)
    values (#{id,jdbcType=INTEGER}, #{accountName,jdbcType=VARCHAR}, #{accountAppid,jdbcType=VARCHAR}, 
      #{accountAppsecret,jdbcType=VARCHAR}, #{departId,jdbcType=INTEGER}, #{accountUser,jdbcType=VARCHAR}, 
      #{accountUserPhone,jdbcType=VARCHAR}, #{accountCount,jdbcType=INTEGER}, #{redirectUrl,jdbcType=VARCHAR}, 
      #{signName,jdbcType=VARCHAR}, #{templateCode,jdbcType=VARCHAR}, #{accessKeyid,jdbcType=VARCHAR}, 
      #{accessKeysecret,jdbcType=VARCHAR}, #{remark,jdbcType=VARCHAR}, #{status,jdbcType=SMALLINT}, 
      #{deleteFlag,jdbcType=SMALLINT}, #{createBy,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, 
      #{updateBy,jdbcType=VARCHAR}, #{updateDate,jdbcType=TIMESTAMP}, #{param1,jdbcType=VARCHAR}, 
      #{param2,jdbcType=VARCHAR}, #{param3,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.dayuan.bean.wxAccount.wxAccount">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 08 15:10:08 CST 2018.
    -->
    insert into wx_account
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="accountName != null">
        account_name,
      </if>
      <if test="accountAppid != null">
        account_appid,
      </if>
      <if test="accountAppsecret != null">
        account_appsecret,
      </if>
      <if test="departId != null">
        depart_id,
      </if>
      <if test="accountUser != null">
        account_user,
      </if>
      <if test="accountUserPhone != null">
        account_user_phone,
      </if>
      <if test="accountCount != null">
        account_count,
      </if>
      <if test="redirectUrl != null">
        redirect_url,
      </if>
      <if test="signName != null">
        sign_name,
      </if>
      <if test="templateCode != null">
        template_code,
      </if>
      <if test="accessKeyid != null">
        access_keyid,
      </if>
      <if test="accessKeysecret != null">
        access_keysecret,
      </if>
      <if test="remark != null">
        remark,
      </if>
      <if test="status != null">
        status,
      </if>
      <if test="deleteFlag != null">
        delete_flag,
      </if>
      <if test="createBy != null">
        create_by,
      </if>
      <if test="createDate != null">
        create_date,
      </if>
      <if test="updateBy != null">
        update_by,
      </if>
      <if test="updateDate != null">
        update_date,
      </if>
      <if test="param1 != null">
        param1,
      </if>
      <if test="param2 != null">
        param2,
      </if>
      <if test="param3 != null">
        param3,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=INTEGER},
      </if>
      <if test="accountName != null">
        #{accountName,jdbcType=VARCHAR},
      </if>
      <if test="accountAppid != null">
        #{accountAppid,jdbcType=VARCHAR},
      </if>
      <if test="accountAppsecret != null">
        #{accountAppsecret,jdbcType=VARCHAR},
      </if>
      <if test="departId != null">
        #{departId,jdbcType=INTEGER},
      </if>
      <if test="accountUser != null">
        #{accountUser,jdbcType=VARCHAR},
      </if>
      <if test="accountUserPhone != null">
        #{accountUserPhone,jdbcType=VARCHAR},
      </if>
      <if test="accountCount != null">
        #{accountCount,jdbcType=INTEGER},
      </if>
      <if test="redirectUrl != null">
        #{redirectUrl,jdbcType=VARCHAR},
      </if>
      <if test="signName != null">
        #{signName,jdbcType=VARCHAR},
      </if>
      <if test="templateCode != null">
        #{templateCode,jdbcType=VARCHAR},
      </if>
      <if test="accessKeyid != null">
        #{accessKeyid,jdbcType=VARCHAR},
      </if>
      <if test="accessKeysecret != null">
        #{accessKeysecret,jdbcType=VARCHAR},
      </if>
      <if test="remark != null">
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        #{status,jdbcType=SMALLINT},
      </if>
      <if test="deleteFlag != null">
        #{deleteFlag,jdbcType=SMALLINT},
      </if>
      <if test="createBy != null">
        #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null">
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateBy != null">
        #{updateBy,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null">
        #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="param1 != null">
        #{param1,jdbcType=VARCHAR},
      </if>
      <if test="param2 != null">
        #{param2,jdbcType=VARCHAR},
      </if>
      <if test="param3 != null">
        #{param3,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.dayuan.bean.wxAccount.wxAccount">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 08 15:10:08 CST 2018.
    -->
    update wx_account
    <set>
      <if test="accountName != null">
        account_name = #{accountName,jdbcType=VARCHAR},
      </if>
      <if test="accountAppid != null">
        account_appid = #{accountAppid,jdbcType=VARCHAR},
      </if>
      <if test="accountAppsecret != null">
        account_appsecret = #{accountAppsecret,jdbcType=VARCHAR},
      </if>
      <if test="departId != null">
        depart_id = #{departId,jdbcType=INTEGER},
      </if>
      <if test="accountUser != null">
        account_user = #{accountUser,jdbcType=VARCHAR},
      </if>
      <if test="accountUserPhone != null">
        account_user_phone = #{accountUserPhone,jdbcType=VARCHAR},
      </if>
      <if test="accountCount != null">
        account_count = #{accountCount,jdbcType=INTEGER},
      </if>
      <if test="redirectUrl != null">
        redirect_url = #{redirectUrl,jdbcType=VARCHAR},
      </if>
      <if test="signName != null">
        sign_name = #{signName,jdbcType=VARCHAR},
      </if>
      <if test="templateCode != null">
        template_code = #{templateCode,jdbcType=VARCHAR},
      </if>
      <if test="accessKeyid != null">
        access_keyid = #{accessKeyid,jdbcType=VARCHAR},
      </if>
      <if test="accessKeysecret != null">
        access_keysecret = #{accessKeysecret,jdbcType=VARCHAR},
      </if>
      <if test="remark != null">
        remark = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=SMALLINT},
      </if>
      <if test="deleteFlag != null">
        delete_flag = #{deleteFlag,jdbcType=SMALLINT},
      </if>
      <if test="createBy != null">
        create_by = #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null">
        create_date = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="updateBy != null">
        update_by = #{updateBy,jdbcType=VARCHAR},
      </if>
      <if test="updateDate != null">
        update_date = #{updateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="param1 != null">
        param1 = #{param1,jdbcType=VARCHAR},
      </if>
      <if test="param2 != null">
        param2 = #{param2,jdbcType=VARCHAR},
      </if>
      <if test="param3 != null">
        param3 = #{param3,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.dayuan.bean.wxAccount.wxAccount">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Nov 08 15:10:08 CST 2018.
    -->
    update wx_account
    set account_name = #{accountName,jdbcType=VARCHAR},
      account_appid = #{accountAppid,jdbcType=VARCHAR},
      account_appsecret = #{accountAppsecret,jdbcType=VARCHAR},
      depart_id = #{departId,jdbcType=INTEGER},
      account_user = #{accountUser,jdbcType=VARCHAR},
      account_user_phone = #{accountUserPhone,jdbcType=VARCHAR},
      account_count = #{accountCount,jdbcType=INTEGER},
      redirect_url = #{redirectUrl,jdbcType=VARCHAR},
      sign_name = #{signName,jdbcType=VARCHAR},
      template_code = #{templateCode,jdbcType=VARCHAR},
      access_keyid = #{accessKeyid,jdbcType=VARCHAR},
      access_keysecret = #{accessKeysecret,jdbcType=VARCHAR},
      remark = #{remark,jdbcType=VARCHAR},
      status = #{status,jdbcType=SMALLINT},
      delete_flag = #{deleteFlag,jdbcType=SMALLINT},
      create_by = #{createBy,jdbcType=VARCHAR},
      create_date = #{createDate,jdbcType=TIMESTAMP},
      update_by = #{updateBy,jdbcType=VARCHAR},
      update_date = #{updateDate,jdbcType=TIMESTAMP},
      param1 = #{param1,jdbcType=VARCHAR},
      param2 = #{param2,jdbcType=VARCHAR},
      param3 = #{param3,jdbcType=VARCHAR}
    where id = #{id,jdbcType=INTEGER}
  </update>
</mapper>
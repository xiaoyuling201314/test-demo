<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dayuan.mapper.sampling.TbSamplingMapper">
    <resultMap id="BaseResultMap" type="com.dayuan.bean.sampling.TbSampling">
        <id property="id" column="id" />
        <result property="departId" column="depart_id" />
        <result property="pointId" column="point_id" />
        <result property="orderNumber" column="order_number" />
        <result property="orderType" column="order_type" />
        <result property="orderTime" column="order_time" />
        <result property="orderStatus" column="order_status" />
        <result property="orderFees" column="order_fees" />
        <result property="orderUserid" column="order_userid" />
        <result property="orderUsername" column="order_username" />
        <result property="orderUserPhone" column="order_user_phone" />
        <result property="carNumber" column="car_number" />
        <result property="driverName" column="driver_name" />
        <result property="driverPhone" column="driver_phone" />
        <result property="ccuId" column="ccu_id" />
        <result property="ccuName" column="ccu_name" />
        <result property="iuId" column="iu_id" />
        <result property="iuName" column="iu_name" />
        <result property="isSampling" column="is_sampling" />
        <result property="samplingUserid" column="sampling_userid" />
        <result property="samplingUsername" column="sampling_username" />
        <result property="samplingTime" column="sampling_time" />
        <result property="samplingPhotos" column="sampling_photos" />
        <result property="reportTime" column="report_time" />
        <result property="remark" column="remark" />
        <result property="param1" column="param1" />
        <result property="param2" column="param2" />
        <result property="param3" column="param3" />
        <result property="deleteFlag" column="delete_flag" />
        <result property="createBy" column="create_by" />
        <result property="createDate" column="create_date" />
        <result property="updateBy" column="update_by" />
        <result property="updateDate" column="update_date" />

        <!--非表字段-->
        <result column="collectNum" property="collectNum" jdbcType="INTEGER"/>
        <result column="incomeId" property="incomeId" jdbcType="INTEGER"/>
        <result column="incomeNumber" property="incomeNumber" jdbcType="VARCHAR"/>
        <result column="payNumber" property="payNumber" jdbcType="VARCHAR"/>
        <result column="unitsCount" property="unitsCount" jdbcType="INTEGER"/>
        <result column="detailsCount" property="detailsCount" jdbcType="INTEGER"/>
        <result column="checkedCount" property="checkedCount" jdbcType="INTEGER"/>
        <result column="collectTime" property="collectTime" jdbcType="TIMESTAMP"/>
        <result column="payStatus" property="payStatus" jdbcType="TIMESTAMP"/>
        <result column="reg_address" property="regAddress" jdbcType="VARCHAR"/>

    </resultMap>
    <!-- 关联详情表的samplingId -->
    <resultMap id="JoinDetailResultMap" type="com.dayuan.bean.sampling.TbSampling" extends="BaseResultMap">
        <collection column="id" property="samplingDetails" ofType="com.dayuan.bean.sampling.TbSamplingDetail"
                    select="com.dayuan.mapper.sampling.TbSamplingDetailMapper.queryBySamplingId"></collection>
    </resultMap>

    <sql id="Base_Column_List">
        id,depart_id,point_id,order_number,order_type,order_time,
        order_status,order_fees,order_userid,order_username,order_user_phone,
        car_number,driver_name,driver_phone,ccu_id,ccu_name,
        iu_id,iu_name,is_sampling,sampling_userid,sampling_username,
        sampling_time,sampling_photos,report_time,remark,param1,param2,
        param3,delete_flag,create_by,create_date,update_by,
        update_date
    </sql>
<!--    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String">-->
<!--        select-->
<!--        <include refid="Base_Column_List"/>-->
<!--        ,(select count(1) from tb_sampling_detail where sampling_id=#{id,jdbcType=VARCHAR} and delete_flag=0) total-->
<!--        from tb_sampling-->
<!--        where delete_flag= 0 and id = #{id,jdbcType=VARCHAR}-->
<!--    </select>-->
<!--    <delete id="deleteByPrimaryKey" parameterType="java.lang.String">-->
<!--        update tb_sampling set delete_flag=1,update_date=now()-->
<!--        where id in-->
<!--        <foreach collection="array" item="ida" index="index" open="(" close=")" separator=",">-->
<!--            #{ida}-->
<!--        </foreach>-->
<!--    </delete>-->
<!--    <insert id="insert" parameterType="com.dayuan.bean.sampling.TbSampling" useGeneratedKeys="true" keyProperty="id">-->
<!--        ( id,depart_id,point_id,order_number,order_type,order_time,-->
<!--        order_status,order_fees,order_userid,order_username,order_user_phone,-->
<!--        car_number,driver_name,driver_phone,ccu_id,ccu_name,-->
<!--        iu_id,iu_name,is_sampling,sampling_userid,sampling_username,-->
<!--        sampling_time,sampling_photos,remark,param1,param2,-->
<!--        param3,delete_flag,create_by,create_date,update_by,-->
<!--        update_date)-->
<!--        values (#{id},#{departId},#{pointId},-->

<!--        &lt;!&ndash; 新增生成抽样单号 &ndash;&gt;-->
<!--        (-->
<!--        SELECT a.nextNum-->
<!--        FROM-->
<!--        (-->
<!--        SELECT-->
<!--        CONCAT(-->
<!--        #{samplingNo}, &lt;!&ndash; 当前samplingNo参数为抽样单首字母 &ndash;&gt;-->
<!--        date_format(now(), '%Y%m%d'),-->
<!--        (-->
<!--        SELECT-->
<!--        CASE-->
<!--        WHEN b.nextNum IS NULL THEN '0001'-->
<!--        WHEN b.nextNum &lt; 10 THEN CONCAT('000', b.nextNum)-->
<!--        WHEN b.nextNum &lt; 100 THEN CONCAT('00', b.nextNum)-->
<!--        WHEN b.nextNum &lt; 1000 THEN CONCAT('0', b.nextNum)-->
<!--        ELSE b.nextNum-->
<!--        END-->
<!--        FROM-->
<!--        (-->
<!--        SELECT-->
<!--        (MAX(-->
<!--        CAST(-->
<!--        SUBSTRING(order_number, LENGTH(#{samplingNo})+9) AS SIGNED &lt;!&ndash; 当前samplingNo参数为抽样单首字母 &ndash;&gt;-->
<!--        )-->
<!--        ) + 1) nextNum-->
<!--        FROM tb_sampling-->
<!--        WHERE create_date >= CURRENT_DATE()-->
<!--        ) b-->
<!--        )-->
<!--        ) AS nextNum-->
<!--        ) a-->
<!--        ),-->

<!--        #{orderType},#{orderTime},-->
<!--        #{orderStatus},#{orderFees},#{orderUserid},#{orderUsername},#{orderUserPhone},-->
<!--        #{carNumber},#{driverName},#{driverPhone},#{ccuId},#{ccuName},-->
<!--        #{iuId},#{iuName},#{isSampling},#{samplingUserid},#{samplingUsername},-->
<!--        #{samplingTime},#{samplingPhotos},#{remark},#{param1},#{param2},-->
<!--        #{param3},#{deleteFlag},#{createBy},#{createDate},#{updateBy},-->
<!--        #{updateDate})-->
<!--    </insert>-->
<!--    <insert id="insertSelective" keyColumn="id" keyProperty="id" parameterType="com.dayuan.bean.sampling.TbSampling" useGeneratedKeys="true">-->
<!--        insert into tb_sampling-->
<!--        <trim prefix="(" suffix=")" suffixOverrides=",">-->
<!--            <if test="id != null">id,</if>-->
<!--            <if test="departId != null">depart_id,</if>-->
<!--            <if test="pointId != null">point_id,</if>-->
<!--            <if test="orderNumber != null">order_number,</if>-->
<!--            <if test="orderType != null">order_type,</if>-->
<!--            <if test="orderTime != null">order_time,</if>-->
<!--            <if test="orderStatus != null">order_status,</if>-->
<!--            <if test="orderFees != null">order_fees,</if>-->
<!--            <if test="orderUserid != null">order_userid,</if>-->
<!--            <if test="orderUsername != null">order_username,</if>-->
<!--            <if test="orderUserPhone != null">order_user_phone,</if>-->
<!--            <if test="carNumber != null">car_number,</if>-->
<!--            <if test="driverName != null">driver_name,</if>-->
<!--            <if test="driverPhone != null">driver_phone,</if>-->
<!--            <if test="ccuId != null">ccu_id,</if>-->
<!--            <if test="ccuName != null">ccu_name,</if>-->
<!--            <if test="iuId != null">iu_id,</if>-->
<!--            <if test="iuName != null">iu_name,</if>-->
<!--            <if test="isSampling != null">is_sampling,</if>-->
<!--            <if test="samplingUserid != null">sampling_userid,</if>-->
<!--            <if test="samplingUsername != null">sampling_username,</if>-->
<!--            <if test="samplingTime != null">sampling_time,</if>-->
<!--            <if test="samplingPhotos != null">sampling_photos,</if>-->
<!--            <if test="remark != null">remark,</if>-->
<!--            <if test="param1 != null">param1,</if>-->
<!--            <if test="param2 != null">param2,</if>-->
<!--            <if test="param3 != null">param3,</if>-->
<!--            <if test="deleteFlag != null">delete_flag,</if>-->
<!--            <if test="createBy != null">create_by,</if>-->
<!--            <if test="createDate != null">create_date,</if>-->
<!--            <if test="updateBy != null">update_by,</if>-->
<!--            <if test="updateDate != null">update_date,</if>-->
<!--        </trim>-->
<!--        <trim prefix="values (" suffix=")" suffixOverrides=",">-->
<!--            <if test="id != null">#{id},</if>-->
<!--            <if test="departId != null">#{departId},</if>-->
<!--            <if test="pointId != null">#{pointId},</if>-->
<!--            <if test="orderNumber != null">#{orderNumber},</if>-->
<!--            <if test="orderType != null">#{orderType},</if>-->
<!--            <if test="orderTime != null">#{orderTime},</if>-->
<!--            <if test="orderStatus != null">#{orderStatus},</if>-->
<!--            <if test="orderFees != null">#{orderFees},</if>-->
<!--            <if test="orderUserid != null">#{orderUserid},</if>-->
<!--            <if test="orderUsername != null">#{orderUsername},</if>-->
<!--            <if test="orderUserPhone != null">#{orderUserPhone},</if>-->
<!--            <if test="carNumber != null">#{carNumber},</if>-->
<!--            <if test="driverName != null">#{driverName},</if>-->
<!--            <if test="driverPhone != null">#{driverPhone},</if>-->
<!--            <if test="ccuId != null">#{ccuId},</if>-->
<!--            <if test="ccuName != null">#{ccuName},</if>-->
<!--            <if test="iuId != null">#{iuId},</if>-->
<!--            <if test="iuName != null">#{iuName},</if>-->
<!--            <if test="isSampling != null">#{isSampling},</if>-->
<!--            <if test="samplingUserid != null">#{samplingUserid},</if>-->
<!--            <if test="samplingUsername != null">#{samplingUsername},</if>-->
<!--            <if test="samplingTime != null">#{samplingTime},</if>-->
<!--            <if test="samplingPhotos != null">#{samplingPhotos},</if>-->
<!--            <if test="remark != null">#{remark},</if>-->
<!--            <if test="param1 != null">#{param1},</if>-->
<!--            <if test="param2 != null">#{param2},</if>-->
<!--            <if test="param3 != null">#{param3},</if>-->
<!--            <if test="deleteFlag != null">#{deleteFlag},</if>-->
<!--            <if test="createBy != null">#{createBy},</if>-->
<!--            <if test="createDate != null">#{createDate},</if>-->
<!--            <if test="updateBy != null">#{updateBy},</if>-->
<!--            <if test="updateDate != null">#{updateDate},</if>-->
<!--        </trim>-->
<!--    </insert>-->
<!--    <update id="updateByPrimaryKeySelective" parameterType="com.dayuan.bean.sampling.TbSampling">-->
<!--        update tb_sampling-->
<!--        <set>-->
<!--            <if test="departId != null">-->
<!--                depart_id = #{departId},-->
<!--            </if>-->
<!--            <if test="pointId != null">-->
<!--                point_id = #{pointId},-->
<!--            </if>-->
<!--            <if test="orderNumber != null">-->
<!--                order_number = #{orderNumber},-->
<!--            </if>-->
<!--            <if test="orderType != null">-->
<!--                order_type = #{orderType},-->
<!--            </if>-->
<!--            <if test="orderTime != null">-->
<!--                order_time = #{orderTime},-->
<!--            </if>-->
<!--            <if test="orderStatus != null">-->
<!--                order_status = #{orderStatus},-->
<!--            </if>-->
<!--            <if test="orderFees != null">-->
<!--                order_fees = #{orderFees},-->
<!--            </if>-->
<!--            <if test="orderUserid != null">-->
<!--                order_userid = #{orderUserid},-->
<!--            </if>-->
<!--            <if test="orderUsername != null">-->
<!--                order_username = #{orderUsername},-->
<!--            </if>-->
<!--            <if test="orderUserPhone != null">-->
<!--                order_user_phone = #{orderUserPhone},-->
<!--            </if>-->
<!--            <if test="carNumber != null">-->
<!--                car_number = #{carNumber},-->
<!--            </if>-->
<!--            <if test="driverName != null">-->
<!--                driver_name = #{driverName},-->
<!--            </if>-->
<!--            <if test="driverPhone != null">-->
<!--                driver_phone = #{driverPhone},-->
<!--            </if>-->
<!--            <if test="ccuId != null">-->
<!--                ccu_id = #{ccuId},-->
<!--            </if>-->
<!--            <if test="ccuName != null">-->
<!--                ccu_name = #{ccuName},-->
<!--            </if>-->
<!--            <if test="iuId != null">-->
<!--                iu_id = #{iuId},-->
<!--            </if>-->
<!--            <if test="iuName != null">-->
<!--                iu_name = #{iuName},-->
<!--            </if>-->
<!--            <if test="isSampling != null">-->
<!--                is_sampling = #{isSampling},-->
<!--            </if>-->
<!--            <if test="samplingUserid != null">-->
<!--                sampling_userid = #{samplingUserid},-->
<!--            </if>-->
<!--            <if test="samplingUsername != null">-->
<!--                sampling_username = #{samplingUsername},-->
<!--            </if>-->
<!--            <if test="samplingTime != null">-->
<!--                sampling_time = #{samplingTime},-->
<!--            </if>-->
<!--            <if test="samplingPhotos != null">-->
<!--                sampling_photos = #{samplingPhotos},-->
<!--            </if>-->
<!--            <if test="remark != null">-->
<!--                remark = #{remark},-->
<!--            </if>-->
<!--            <if test="param1 != null">-->
<!--                param1 = #{param1},-->
<!--            </if>-->
<!--            <if test="param2 != null">-->
<!--                param2 = #{param2},-->
<!--            </if>-->
<!--            <if test="param3 != null">-->
<!--                param3 = #{param3},-->
<!--            </if>-->
<!--            <if test="deleteFlag != null">-->
<!--                delete_flag = #{deleteFlag},-->
<!--            </if>-->
<!--            <if test="createBy != null">-->
<!--                create_by = #{createBy},-->
<!--            </if>-->
<!--            <if test="createDate != null">-->
<!--                create_date = #{createDate},-->
<!--            </if>-->
<!--            <if test="updateBy != null">-->
<!--                update_by = #{updateBy},-->
<!--            </if>-->
<!--            <if test="updateDate != null">-->
<!--                update_date = #{updateDate},-->
<!--            </if>-->
<!--        </set>-->
<!--        where   id = #{id}-->
<!--    </update>-->
<!--    <update id="updateByPrimaryKey" parameterType="com.dayuan.bean.sampling.TbSampling">-->
<!--        update tb_sampling-->
<!--        set-->
<!--            depart_id =  #{departId},-->
<!--            point_id =  #{pointId},-->
<!--            order_number =  #{orderNumber},-->
<!--            order_type =  #{orderType},-->
<!--            order_time =  #{orderTime},-->
<!--            order_status =  #{orderStatus},-->
<!--            order_fees =  #{orderFees},-->
<!--            order_userid =  #{orderUserid},-->
<!--            order_username =  #{orderUsername},-->
<!--            order_user_phone =  #{orderUserPhone},-->
<!--            car_number =  #{carNumber},-->
<!--            driver_name =  #{driverName},-->
<!--            driver_phone =  #{driverPhone},-->
<!--            ccu_id =  #{ccuId},-->
<!--            ccu_name =  #{ccuName},-->
<!--            iu_id =  #{iuId},-->
<!--            iu_name =  #{iuName},-->
<!--            is_sampling =  #{isSampling},-->
<!--            sampling_userid =  #{samplingUserid},-->
<!--            sampling_username =  #{samplingUsername},-->
<!--            sampling_time =  #{samplingTime},-->
<!--            sampling_photos =  #{samplingPhotos},-->
<!--            remark =  #{remark},-->
<!--            param1 =  #{param1},-->
<!--            param2 =  #{param2},-->
<!--            param3 =  #{param3},-->
<!--            delete_flag =  #{deleteFlag},-->
<!--            create_by =  #{createBy},-->
<!--            create_date =  #{createDate},-->
<!--            update_by =  #{updateBy},-->
<!--            update_date =  #{updateDate}-->
<!--        where   id = #{id}-->
<!--    </update>-->

    <select id="loadDatagrid" resultMap="BaseResultMap" parameterType="Object">
        select tb1.*,(select count(1) from tb_sampling_detail where sampling_id=tb1.id) as detailsCount,
        (select count(1) from data_check_recording FORCE INDEX(idx_sampling_id) where sampling_id=tb1.id and delete_flag=0) as checkedCount,
        bp.point_name pointName
        from tb_sampling tb1 FORCE INDEX(idx_depart_date)
        left join base_point bp on tb1.point_id=bp.id
        <include refid="Example_Where_Clause"></include>
        order by tb1.create_date ${order} limit #{rowOffset}, #{pageSize}
    </select>

    <select id="loadDatagrid2" resultMap="BaseResultMap" parameterType="Object">
        select tb1.*,(select count(1) from tb_sampling_detail where sampling_id=tb1.id) as detailsCount,
        (select count(1) from data_check_recording FORCE INDEX(idx_sampling_id) where sampling_id=tb1.id and delete_flag=0) as checkedCount,
        bp.point_name pointName
        from tb_sampling tb1 FORCE INDEX(idx_depart_date)
        left join base_point bp on tb1.point_id=bp.id
        <include refid="Example_Where_Clause2"></include>
        order by tb1.order_time ${order} limit #{rowOffset}, #{pageSize}
    </select>

    <select id="getRowTotal" resultType="java.lang.Integer" parameterType="Object">
        select count(1) as rowTotal
        from
        (
            select tb1.id, (select count(1) from tb_sampling_detail where sampling_id=tb1.id) as total,
            (select count(1) from data_check_recording FORCE INDEX(idx_sampling_id) where sampling_id=tb1.id and delete_flag=0) as completionNum
            from tb_sampling tb1 FORCE INDEX(idx_depart_date)
            left join base_point bp on tb1.point_id=bp.id
            <include refid="Example_Where_Clause"></include>
        ) tb2
    </select>

    <select id="getRowTotal2" resultType="java.lang.Integer" parameterType="Object">
        select count(1)
        from tb_sampling tb1 FORCE INDEX(idx_depart_date)
        left join base_point bp on tb1.point_id = bp.id
        <include refid="Example_Where_Clause2"></include>
    </select>

    <sql id="Example_Where_Clause">
        where tb1.delete_flag=0
        <if test="obj.departArr != null and obj.departArr.length > 0">
            and tb1.depart_id in
            <foreach item="item" index="index" collection="obj.departArr" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="obj.pointArr != null and obj.pointArr.length > 0">
            and tb1.point_id in
            <foreach item="item" index="index" collection="obj.pointArr" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="obj.userRegId != null">
            and tb1.reg_id = #{obj.userRegId}
        </if>
        <if test="obj.keyWords != null and obj.keyWords != ''">
            and (
            tb1.order_number like CONCAT('%',#{obj.keyWords},'%')
            or tb1.reg_name like CONCAT('%',#{obj.keyWords},'%')
            or tb1.reg_link_phone like CONCAT('%',#{obj.keyWords},'%')
            or tb1.ope_name like CONCAT('%',#{obj.keyWords},'%')
            or tb1.ope_shop_name like CONCAT('%',#{obj.keyWords},'%')
            or bp.point_name like CONCAT('%',#{obj.keyWords},'%')
            )
        </if>
        <if test="obj.samplingDateStartDate != null and obj.samplingDateStartDate != ''">
            AND tb1.create_date &gt;= CONCAT(#{obj.samplingDateStartDate},' 00:00:00')
        </if>
        <if test="obj.samplingDateEndDate != null and obj.samplingDateEndDate != ''">
            AND tb1.create_date &lt;= CONCAT(#{obj.samplingDateEndDate},' 23:59:59')
        </if>
        <if test="obj.tbSampling != null">
            <if test="obj.tbSampling.samplingNo !=null and obj.tbSampling.samplingNo != null">
                and tb1.order_number like CONCAT('%',#{obj.tbSampling.samplingNo},'%')
            </if>
            <if test="obj.tbSampling.regName !=null and obj.tbSampling.regName !=''">
                and tb1.reg_name like CONCAT('%',#{obj.tbSampling.regName},'%')
            </if>
            <if test="obj.tbSampling.opeShopName !=null and obj.tbSampling.opeShopName !=''">
                and tb1.ope_shop_name like CONCAT('%',#{obj.tbSampling.opeShopName},'%')
            </if>
            <if test="obj.tbSampling.opeShopCode !=null and obj.tbSampling.opeShopCode !=''">
                and tb1.ope_shop_code like CONCAT('%',#{obj.tbSampling.opeShopCode},'%')
            </if>
            <if test="obj.tbSampling.personal != null">
                and tb1.personal = #{obj.tbSampling.personal}
            </if>
            <if test="obj.tbSampling.pointName !=null and obj.tbSampling.pointName !=''">
                and bp.point_name like CONCAT('%',#{obj.tbSampling.pointName},'%')
            </if>
        </if>

        <if test="obj.finish != null">
            <choose>
                <when test="obj.finish == 2">HAVING total != completionNum</when>
                <when test="obj.finish == 3">HAVING total = completionNum</when>
            </choose>
        </if>
    </sql>
    <sql id="Example_Where_Clause2">
        where tb1.delete_flag=0
        <if test="obj.departArr != null and obj.departArr.length > 0">
            and tb1.depart_id in
            <foreach item="item" index="index" collection="obj.departArr" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="obj.pointArr != null and obj.pointArr.length > 0">
            and tb1.point_id in
            <foreach item="item" index="index" collection="obj.pointArr" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="obj.checkStatus != null and obj.checkStatus != ''">
            and tb1.order_status=#{obj.checkStatus}
        </if>
        <if test="obj.checkProgress != null and obj.checkProgress != ''">
            and tb1.is_sampling=#{obj.checkProgress}
        </if>
        <if test="obj.keyWords != null and obj.keyWords != ''">
            and (
            tb1.order_number like CONCAT('%',#{obj.keyWords},'%')
            or tb1.order_username like CONCAT('%',#{obj.keyWords},'%')
            or tb1.order_user_phone like CONCAT('%',#{obj.keyWords},'%')
            or tb1.ccu_name like CONCAT('%',#{obj.keyWords},'%')
            or tb1.iu_name like CONCAT('%',#{obj.keyWords},'%')
            )
        </if>
        <if test="obj.samplingDateStartDate != null and obj.samplingDateStartDate != ''">
            AND tb1.create_date &gt;= CONCAT(#{obj.samplingDateStartDate},' 00:00:00')
        </if>
        <if test="obj.samplingDateEndDate != null and obj.samplingDateEndDate != ''">
            AND tb1.create_date &lt;= CONCAT(#{obj.samplingDateEndDate},' 23:59:59')
        </if>
        <if test="obj.finish != null">
            <choose>
                <when test="obj.finish == 2">HAVING total != completionNum</when>
                <when test="obj.finish == 3">HAVING total = completionNum</when>
            </choose>
        </if>
    </sql>
    <sql id="Example_Where_Clause_Query">
        where delete_flag=0
        <if test="obj.tbSampling != null">
            <if test="obj.tbSampling.samplingNo !=null and obj.tbSampling.samplingNo != null">
                and order_number like CONCAT('%',#{obj.tbSampling.samplingNo},'%')
            </if>
            <if test="obj.tbSampling.opeShopName !=null and obj.tbSampling.opeShopName != null">
                and ope_shop_name like CONCAT('%',#{obj.tbSampling.opeShopName},'%')
            </if>
            <if test="obj.tbSampling.opeName !=null and obj.tbSampling.opeName != null">
                and ope_name like CONCAT('%',#{obj.tbSampling.opeName},'%')
            </if>
            <if test="obj.tbSampling.regLinkPerson !=null and obj.tbSampling.regLinkPerson != null">
                and reg_link_person like CONCAT('%',#{obj.tbSampling.regLinkPerson},'%')
            </if>
        </if>
    </sql>


    <!-- 根据数据来源查询 最大 单号 -->
    <select id="queryLastCode" resultType="java.lang.String">
        SELECT MAX(order_number)
        FROM tb_sampling
        WHERE order_number LIKE CONCAT(#{samplingNo}, '%')
    </select>
    <!--
    <select id="queryByPid" resultMap="JoinDetailResultMap" parameterType="Object">
        select
        <include refid="Base_Column_List"/>
        from tb_sampling s
        WHERE status=0 and sampling_userid in
        (select id from t_s_user where delete_flag=0
        <if test="pointId !=null">
            and point_id=#{pointId}
        </if>
        <if test="departId !=null">
            and FIND_IN_SET(depart_id,getChildDepartLst(#{departId}))
        </if>
        )
        and update_date>#{lastUpdateTime}
    </select>
    -->
    <select id="queryBySamplingNo" resultMap="BaseResultMap" parameterType="Object">
        select
        <include refid="Base_Column_List"/>
        ,(select SUM(IF(print_code_num is NULL, 1, 0)) from tb_sampling_detail where sampling_id = ts.id) collectNum
        from tb_sampling ts
        where delete_flag=0 and order_number=#{samplingNo} and order_status!=4
    </select>

    <!-- /**
     * 保存抽样单的视频文件地址
     * @param samplingId
     * @param filePath
     * @author LuoYX
     * @date 2018年8月21日
     */
    void updateSamplingVideoPath(@Param("samplingId")Integer samplingId,@Param("filePath") String filePath); -->
    <update id="updateSamplingVideoPath" parameterType="Object">
        UPDATE tb_sampling
        SET video_path = #{filePath}
        WHERE id = #{samplingId}
    </update>

    <select id="queryByParam2" resultMap="BaseResultMap" parameterType="Object">
        select
        <include refid="Base_Column_List"/>
        from tb_sampling
        where param2=#{param2}
    </select>
    <select id="queryByInspectionUnit" resultMap="BaseResultMap" parameterType="Object">
        select s.*,count(d.id) total, count((dr.delete_flag=0 and dr.conclusion='合格' or dr.reload_flag=2) or null ) as completionNum,
        d.sample_tube_time AS collectTime,s.take_sampling_modal AS takeSamplingModal,s.is_take_sampling AS isTakeSampling,
        CASE
        WHEN dr.conclusion = '合格' THEN '合格'
        WHEN dr.conclusion = '不合格' AND dr.reload_flag &gt;= #{checkNumber} THEN '不合格'
        ELSE '' END AS conclusion
        from tb_sampling s
        left join tb_sampling_detail d on s.id=d.sampling_id
        left join data_check_recording dr on dr.sampling_id=s.id and d.id=dr.sampling_detail_id
        where s.delete_flag=0 and s.create_by =#{userId}
        <if test="createDate!=null">
            <choose>
                <when test="orderType==1">
                    AND d.sample_tube_time &gt;= CONCAT(#{createDate}, ' 00:00:00')
                    AND d.sample_tube_time &lt;= CONCAT(#{createDate}, ' 23:59:59')
                </when>
                <otherwise>
                    AND s.create_date &gt;= CONCAT(#{createDate}, ' 00:00:00')
                    AND s.create_date &lt;= CONCAT(#{createDate}, ' 23:59:59')
                </otherwise>
            </choose>
        </if>
        <!-- 微信端使用查询 -->
        <if test="satrtTime!=null">
            <choose>
                <when test="orderType==1">
                    AND d.sample_tube_time &gt;= #{satrtTime}
                    AND d.sample_tube_time &lt;= #{endTime}
                </when>
                <otherwise>
                    AND s.create_date &gt;=#{satrtTime}
                    AND s.create_date &lt;= #{endTime}
                </otherwise>
            </choose>
        </if>
        <if test="orderStatus !=null">
            and s.personal=2
            and s.order_status=${orderStatus}
        </if>
        <!-- 当获取待付款和已取消时 只取微信端订单 -->
        <if test="orderStatus ==3 or orderStatus==1">
            and s.order_platform=1
        </if>
        GROUP BY s.id
        <choose>
            <when test="orderType==1">
                order by d.sample_tube_time desc
            </when>
            <otherwise>
                order by s.sampling_date desc
            </otherwise>
        </choose>
        <if test="rowStart !=null and rowEnd!=null">
            limit #{rowStart}, #{rowEnd}
        </if>
    </select>
    <!-- 微信开票查询送检用户下单列表 2019-9-12 huht -->
    <select id="queryByInspectionUnit2" resultMap="BaseResultMap" parameterType="Object">
        select id, order_number, pay_date,create_date,inspection_fee

        from tb_sampling

        where delete_flag=0 and personal=2 and order_status=2 and create_by =#{userId} AND invoice_id is NULL
        <if test="start!=null">
            and pay_date &gt;=#{start}
        </if>
        <if test="end!=null">
            and pay_date &lt;=#{end}
        </if>
        order by pay_date desc
        <if test="rowStart !=null and rowEnd!=null">
            limit #{rowStart}, #{rowEnd}
        </if>
    </select>
    <select id="queryByInspectionUnitCount" resultType="java.lang.Integer" parameterType="Object">
        select COUNT(DISTINCT s.id)
        from tb_sampling s
        left join tb_sampling_detail d on s.id=d.sampling_id
        where s.delete_flag=0 and s.create_by =${userId}
        <if test="orderStatus !=null">
            and s.personal=2
            and s.order_status=${orderStatus}
        </if>
        <if test="createDate!=null">
            <choose>
                <when test="orderType==1">
                    and d.sample_tube_time like CONCAT(#{createDate},'%')
                </when>
                <otherwise>
                    and s.create_date like CONCAT(#{createDate},'%')
                </otherwise>
            </choose>
        </if>
    </select>

    <select id="queryByIdAndInspection" resultMap="BaseResultMap" parameterType="Object">
        select count(d.id) total,
        <if test="inspectionId!=null">
            (select company_name from inspection_unit where id=${inspectionId}) inspection_name,
        </if>
        s.* from tb_sampling s
        left join tb_sampling_detail d on s.id=d.sampling_id
        where s.id=${samplingId}
    </select>


    <select id="queryByReportCode" resultMap="BaseResultMap" parameterType="Object">
        SELECT DISTINCT
            s.id,
            s.*
        FROM tb_sampling s
            LEFT JOIN tb_sampling_detail d ON s.id = d.sampling_id
        WHERE d.collect_code = #{reportCode}
              AND sample_tube_time >= #{validityTime}
    </select>

    <!-- 修改订单状态  2019-7-10 huht-->
    <update id="updateSamplingStatus" parameterType="Object">
        UPDATE tb_sampling
        SET order_status = #{orderStatus}
        WHERE id = #{id} AND personal = 2
    </update>
    <!-- 定时取消未支付订单 2019-8-30 huht -->
    <update id="UpdateByOrderStatus" parameterType="Object">
        <!-- update by xiaoyl 2020-03-20 通过执行存储过程取消订单 并且关闭订单的交易记录-->
        CALL cancelOrder(#{samplingDate})
    </update>
    <!-- 查询超时待支付订单信息 add by xiaoyl 2020-03-20 -->
    <select id="queryAllTimeOutOrder" resultMap="BaseResultMap" parameterType="Object">
        SELECT
            ts.id,
            ts.order_number,
            ts.order_status,
            inc.id       incomeId,
            inc.number   incomeNumber,
            inc.`status` payStatus
        FROM tb_sampling ts
            LEFT JOIN income inc ON ts.id = inc.sampling_id
        WHERE order_status = 1  AND ts.create_date &lt;= #{samplingDate}
    </select>
    <!--
    <select id="loadDatagridOrder" resultMap="BaseResultMap" parameterType="Object">
        SELECT tb1.id, tb1.order_number, tb1.sampling_date, tb1.reg_id, tb1.reg_name, tb1.reg_link_phone, tb1.sampling_username,tb1.param3,
        tb1.print_type, tb1.print_num, tb1.expedited, tb1.order_status, tb1.inspection_fee, tb1.printing_fee, tb1.order_platform, tb1.pay_date,
        tb1.take_sampling_modal,tb1.is_take_sampling,tb1.take_sampling_username,tb1.take_food_Date,
        ic.id incomeId, ic.number incomeNumber, ic.pay_number payNumber
        FROM
        (
            SELECT ts.id, ts.order_number, ts.create_date, ts.reg_id, ts.reg_name, ts.reg_link_phone, ts.sampling_username,ts.param3,
                ts.print_type, ts.print_num, ts.expedited, ts.order_status, ts.inspection_fee, ts.printing_fee, ts.order_platform, ts.pay_date,
                ts.take_sampling_modal,ts.is_take_sampling,ts.take_sampling_username,ts.take_food_Date
            FROM tb_sampling ts
            &lt;!&ndash; 高级查询过滤条件 &ndash;&gt;
            <include refid="check_Where_Clause"/>
            ORDER BY ts.create_date ${order} LIMIT #{rowOffset}, #{pageSize}
        ) tb1
        LEFT JOIN income ic ON tb1.id = ic.sampling_id AND ic.delete_flag = 0
        GROUP BY tb1.id
        <if test="obj.payNumber!=null and obj.payNumber!=''">
            HAVING payNumber=#{obj.payNumber}
        </if>
        ORDER BY tb1.sampling_date ${order}
    </select>
    -->
    <select id="loadDatagridOrder" resultMap="BaseResultMap" parameterType="Object">
        SELECT ts.id, ts.order_number, ts.create_date, ts.reg_id, ts.reg_name, ts.reg_link_phone, ts.sampling_username,ts.param3,
        ts.print_type, ts.print_num, ts.expedited, ts.order_status, ts.printing_fee, ts.order_platform, ts.pay_date,
        ts.take_sampling_modal,ts.is_take_sampling,ts.take_sampling_username, ts.take_food_Date,
        COUNT(tsd.id) detailsCount,
        SUM( IF(dcr.conclusion = '合格' OR (dcr.conclusion = '不合格' AND dcr.reload_flag >= #{obj.checkNumber}), 1, 0) ) checkedCount,
        MAX(tsd.sample_tube_time) collectTime
        FROM tb_sampling ts
        LEFT JOIN tb_sampling_detail tsd ON ts.id = tsd.sampling_id
        LEFT JOIN data_check_recording dcr ON dcr.sampling_detail_id = tsd.id
        <include refid="check_Where_Clause"/>
        ORDER BY ts.create_date ${order} LIMIT #{rowOffset}, #{pageSize}
    </select>

    <select id="getRowTotalOrder" resultType="java.lang.Integer" parameterType="Object">
        SELECT count(tb1.id) as rowTotal
        FROM ( SELECT ts.id, COUNT(tsd.id) detailsCount, SUM( IF(dcr.conclusion = '合格' OR (dcr.conclusion = '不合格' AND dcr.reload_flag >=
        #{obj.checkNumber}), 1, 0) ) checkedCount
        FROM tb_sampling ts
        LEFT JOIN tb_sampling_detail tsd ON ts.id = tsd.sampling_id
        LEFT JOIN data_check_recording dcr ON dcr.sampling_detail_id = tsd.id
        <include refid="check_Where_Clause"/>
        ) tb1
    </select>

    <select id="queryTotalMoney" resultType="java.lang.Double" parameterType="Object">
        SELECT IFNULL(sum(tb1.order_fees),0) as rowTotal
        FROM ( SELECT ts.id,ts.order_fees, COUNT(tsd.id) detailsCount, SUM( IF(dcr.conclusion = '合格' OR (dcr.conclusion = '不合格' AND
        dcr.reload_flag >= #{obj.checkNumber}), 1, 0) ) checkedCount
        FROM tb_sampling ts
        LEFT JOIN tb_sampling_detail tsd ON ts.id = tsd.sampling_id
        LEFT JOIN data_check_recording dcr ON dcr.sampling_detail_id = tsd.id
        <include refid="check_Where_Clause"/>
        ) tb1
    </select>

    <select id="queryTotalMoney2" resultType="java.lang.Double" parameterType="Object">
        SELECT IFNULL(sum(tb1.order_fees),0) as rowTotal
        FROM tb_sampling tb1 FORCE INDEX(idx_depart_date)
        LEFT JOIN base_point bp ON tb1.point_id = bp.id
        <include refid="Example_Where_Clause2"></include>
    </select>
    <sql id="check_Where_Clause">
        <where>
            ts.delete_flag = 0
        </where>
        <if test="obj.samplingStartDate!=null and obj.samplingStartDate!=''">
            AND ts.create_date &gt;= #{obj.samplingStartDate}
        </if>
        <if test="obj.samplingEndDate!=null and obj.samplingEndDate!=''">
            AND ts.create_date &lt;= CONCAT(#{obj.samplingEndDate},' 23:59:59')
        </if>
        <if test="obj.payDateStartDate!=null and obj.payDateStartDate!=''">
            AND ts.pay_date &gt;= #{obj.payDateStartDate}
        </if>
        <if test="obj.payDateEndDate!=null and obj.payDateEndDate!=''">
            AND ts.pay_date &lt;= CONCAT(#{obj.payDateEndDate},' 23:59:59')
        </if>
        <if test="obj.keyWords!=null">
            and (ts.order_number like CONCAT('%', #{obj.keyWords}, '%') or ts.reg_name like CONCAT('%', #{obj.keyWords}, '%')
            or ts.sampling_username like CONCAT('%', #{obj.keyWords}, '%') or ts.param3 like CONCAT('%', #{obj.keyWords}, '%') )
        </if>
        <if test="obj.takeSamplingModal !=null">
            and ts.take_sampling_modal = #{obj.takeSamplingModal}
        </if>
        <if test="obj.tbSampling !=null">
            <if test="obj.tbSampling.orderStatus !=null">
                and ts.order_status = #{obj.tbSampling.orderStatus}
            </if>
            <if test="obj.tbSampling.samplingNo !=null and obj.tbSampling.samplingNo !=''">
                and ts.order_number like CONCAT('%', #{obj.tbSampling.samplingNo}, '%')
            </if>
            <if test="obj.tbSampling.regName !=null and obj.tbSampling.regName !=''">
                and ts.reg_name like CONCAT('%', #{obj.tbSampling.regName}, '%')
            </if>
            <if test="obj.tbSampling.samplingUsername !=null and obj.tbSampling.samplingUsername !=''">
                and ts.sampling_username like CONCAT('%', #{obj.tbSampling.samplingUsername}, '%')
            </if>
            <if test="obj.tbSampling.param3 !=null and obj.tbSampling.param3 !=''">
                and ts.param3 like CONCAT('%', #{obj.tbSampling.param3}, '%')
            </if>
            <if test="obj.tbSampling.samplingUserid !=null and obj.tbSampling.samplingUserid !=''">
                and ts.sampling_userid = #{obj.tbSampling.samplingUserid}
            </if>
        </if>
        GROUP BY ts.id
        <choose>
            <when test="obj.checkProgress==1">
                HAVING checkedCount=detailsCount
            </when>
            <when test="obj.checkProgress==2">
                HAVING checkedCount&lt;detailsCount
            </when>
            <otherwise></otherwise>
        </choose>
    </sql>

    <!-- 根据订单ID查询送检订单相关信息 ,用于不登录打印查询报告 add by xiaoyl 2019-07-27  -->
    <select id="queryBySamplingId" resultMap="BaseResultMap" parameterType="Object">
        SELECT
            s.*,
            (SELECT count(1)
             FROM tb_sampling_detail
             WHERE sampling_id = s.id)                            total,
            (SELECT count(1)
             FROM data_check_recording d
             WHERE d.sampling_id = s.id AND d.delete_flag = 0) AS completionNum
        FROM tb_sampling s
        WHERE s.delete_flag = 0 AND s.id = ${samplingId}
    </select>

    <select id="loadDatagridForIncome" resultMap="BaseResultMap" parameterType="Object">
        <!-- select s.id,s.order_number,s.sampling_date,s.sampling_username, s.reg_name,s.order_platform,
      (select sum(money) from income where delete_flag=0 and transaction_type=0 and sampling_id=s.id) inspectionFee,
      (select sum(money) from income where delete_flag=0 and transaction_type=1 and sampling_id=s.id) printingFee
      from tb_sampling s
      where s.delete_flag=0 and s.personal = 2 and s.order_status=2
      and s.create_by=10001 -->
        select s.id,s.order_number,s.sampling_date,s.sampling_username, s.reg_name,s.order_platform,a.inspection_fee,a.printing_fee
        from tb_sampling s
        left join (
        select sampling_id, sum(if(transaction_type=0 and `status`=1,money,0) )inspection_fee,
        sum(if(transaction_type=1 and `status`=1,money,0)) printing_fee from income where delete_flag=0
        <if test="obj.payDate!=null and obj.payDate!=''">
            and pay_date like CONCAT(#{obj.payDate},'%')
        </if>
        GROUP BY sampling_id) a on s.id=a.sampling_id
        where s.delete_flag=0 and s.personal = 2 and s.order_status=2
        <if test="obj.payDate!=null and obj.payDate!=''">
            and s.pay_date like CONCAT(#{obj.payDate},'%')
        </if>
        <if test="obj.keyWords!=null">
            and (s.order_number like CONCAT(#{obj.keyWords},'%') or s.reg_name like CONCAT(#{obj.keyWords},'%') )
        </if>
        <if test="obj.beginDate !=null and obj.beginDate != ''">
            and date_format(s.pay_date,'%Y-%m-%d') >= #{obj.beginDate}
        </if>
        <if test="obj.endDate !=null and obj.endDate !=''">
            and date_format(s.pay_date,'%Y-%m-%d') &lt;= #{obj.endDate}
        </if>
        <if test="obj.currentMonth !=null and obj.currentMonth !=''">
            and date_format(s.pay_date,'%Y-%m') = date_format(#{obj.currentMonth},'%Y-%m')
        </if>
        order by s.sampling_date ${order},s.order_number ${order} LIMIT #{rowOffset}, #{pageSize}
    </select>

    <select id="getRowTotalForIncome" resultType="java.lang.Integer" parameterType="Object">
        select count(1) as rowTotal from tb_sampling s
        where s.delete_flag=0 and s.personal = 2 and s.order_status=2
        <if test="obj.payDate!=null">
            and s.pay_date like CONCAT(#{obj.payDate},'%')
        </if>
        <if test="obj.keyWords!=null">
            and (s.order_number like CONCAT(#{obj.keyWords},'%') or s.reg_name like CONCAT(#{obj.keyWords},'%') )
        </if>
        <if test="obj.beginDate !=null and obj.beginDate != ''">
            and date_format(s.pay_date,'%Y-%m-%d') >= #{obj.beginDate}
        </if>
        <if test="obj.endDate !=null and obj.endDate !=''">
            and date_format(s.pay_date,'%Y-%m-%d') &lt;= #{obj.endDate}
        </if>
        <if test="obj.currentMonth !=null and obj.currentMonth !=''">
            and date_format(s.pay_date,'%Y-%m') = date_format(#{obj.currentMonth},'%Y-%m')
        </if>
    </select>


    <select id="queryByPhone" resultMap="BaseResultMap" parameterType="java.lang.String">
        SELECT ts.id, ts.order_number, ts.ccu_name,ts.iu_name, ts.order_user_phone, ts.order_username,ts.order_time,
        ts.order_fees,SUM(IF(print_code_num is NULL, 1, 0)) collectNum
        FROM tb_sampling ts
        INNER JOIN tb_sampling_detail tsd ON ts.id = tsd.sampling_id
        WHERE ts.delete_flag = 0 AND ts.order_user_phone = #{phone}  AND ts.order_status = 2
        <if test="startTime!=null and startTime!=''">
            AND ts.order_time &gt;= CONCAT(#{startTime},' 00:00:00')
        </if>
        <if test="endTime!=null and endTime!=''">
            AND ts.order_time &lt;= CONCAT(#{endTime},' 23:59:59')
        </if>
        GROUP BY ts.id
        ORDER BY ts.order_time DESC
    </select>

    <select id="loadDatagridQueryOrder" resultMap="BaseResultMap" parameterType="Object">
        SELECT
            ts.id,
            ts.order_number,
            ts.create_date,
            ts.reg_id,
            ts.reg_name,
            ts.reg_link_phone,
            ts.sampling_username,
            ts.param3,
            ts.print_type,
            ts.print_num,
            ts.expedited,
            ts.order_status,
            ts.printing_fee,
            ts.order_platform,
            ts.pay_date,
            ic.pay_number payNumber
        FROM tb_sampling ts
            LEFT JOIN income ic ON ts.id = ic.sampling_id
        WHERE ts.delete_flag = 0 AND ic.delete_flag = 0 AND ic.transaction_type = 0 AND ic.status = 1
              AND (ic.pay_number = #{obj.keyWords} OR ts.order_number = #{obj.keyWords} OR ic.number = #{obj.keyWords})
        ORDER BY ts.create_date  ${order} LIMIT #{rowOffset}, #{pageSize}
    </select>
    <select id="getRowTotalQueryOrder" resultType="java.lang.Integer" parameterType="Object">
        SELECT count(1) AS rowTotal
        FROM tb_sampling ts
            LEFT JOIN income ic ON ts.id = ic.sampling_id
        WHERE ts.delete_flag = 0  AND ic.delete_flag = 0 AND ic.transaction_type = 0 AND ic.status = 1
              AND (ic.pay_number = #{obj.keyWords} OR ts.order_number = #{obj.keyWords} OR ic.number = #{obj.keyWords})

    </select>
    <!--shit 根据订单ID查询订单信息(查询出订单关联的多个委托单位ID)-->
<!--    <select id="selectById" resultMap="BaseResultMap">-->
<!--        SELECT-->
<!--            (SELECT count(1)-->
<!--             FROM tb_sampling_requester-->
<!--             WHERE sampling_id = #{id}) AS unitsCount,-->
<!--            tm.*-->
<!--        FROM tb_sampling tm-->
<!--        WHERE tm.delete_flag = 0 AND tm.id = #{id}-->
<!--    </select>-->

    <!--根据委托单位ID和抽样单ID查询报告信息-->
    <select id="selectByReqestId" resultMap="BaseResultMap">
        SELECT
            ts.id,
            ts.order_number,
            ts.create_date,
            ts.depart_id,
            ts.point_id,
            ts.ope_id,
            ts.ope_shop_code,
            ts.ope_shop_name,
            ts.ope_name,
            ts.ope_phone,
            ts.ope_signature,
            ts.qrcode,
            ts.task_id,
            ts.`status`,
            ts.place_x,
            ts.place_y,
            ts.sampling_userid,
            ts.sampling_username,
            ts.param1,
            ts.param2,
            ts.param3,
            ts.delete_flag,
            ts.create_by,
            ts.create_date,
            ts.update_by,
            ts.update_date,
            ts.video_path,
            ts.report_code,
            ts.print_type,
            ts.print_num,
            ts.expedited,
            ts.order_status,
            ts.scan_num,
            ts.printing_fee,
            ts.order_platform,
            ts.pay_date,
            ts.pay_method,
            ts.param4,
            ts.param5,
            ts.param6,
            ts.invoice_id,
            ts.inspection_id,
            ts.inspection_company,
            ru.requester_name AS regName,
            ru.link_phone     AS regLinkPhone
        FROM
            tb_sampling ts
            LEFT JOIN (SELECT
                           id,
                           requester_name,
                           link_phone
                       FROM requester_unit
                       WHERE delete_flag = 0) ru ON ru.id = #{requestId}
        WHERE
            ts.delete_flag = 0
            AND ts.id = #{samplingId}
    </select>


    <!-- 根据状态查询取样数据 shit-->
    <select id="querySampingList" resultMap="BaseResultMap">
        SELECT
        ts.id,
        ts.reg_name,
        ts.param3,
        ts.order_number,
        ts.inspection_id,
        ts.inspection_company,
        ts.take_sampling_address,
        ts.reg_link_phone,
        ts.create_date,
        ts.is_take_sampling
        FROM
        tb_sampling ts
        WHERE
        ts.delete_flag = 0 AND ts.order_status =2 AND take_sampling_modal =1 AND is_take_sampling = #{status}
        <choose>
            <when test="status==0">ORDER BY ts.create_date ASC</when>
            <when test="status==1">AND ts.take_sampling_userid = #{userId} ORDER BY ts.take_get_Date ASC</when>
            <when test="status==2">AND ts.take_sampling_userid = #{userId} ORDER BY ts.take_food_Date DESC</when>
        </choose>

        <if test="pageNo !=null and pageSize!=null">
            limit #{pageNo}, #{pageSize}
        </if>

    </select>

    <!--更改订单的取样状态 shit-->
    <update id="updateTask">
        UPDATE tb_sampling
        <set>
            is_take_sampling = #{isTakeSampling},
            <choose>
                <when test="isTakeSampling == 0">
                    take_sampling_userid = null,
                    take_sampling_username = null,
                    take_get_Date = null,
                    take_food_Date = null,
                </when>
                <when test="isTakeSampling == 1">
                    take_sampling_userid = #{takeSamplingUserid},
                    take_sampling_username = #{takeSamplingUsername},
                    take_get_Date = #{takeGetDate},
                </when>
                <when test="isTakeSampling == 2">
                    take_food_Date = #{takeFoodDate},
                </when>
            </choose>
            <if test="updateBy != null">
                update_by = #{updateBy},
            </if>
            <if test="updateDate != null">
                update_date = #{updateDate},
            </if>
        </set>
        WHERE id=#{id}
        <if test="isTakeSampling == 0">
            AND is_take_sampling = 1 AND take_sampling_userid = #{takeSamplingUserid}
        </if>
        <if test="isTakeSampling == 1">
            AND is_take_sampling = 0 AND take_sampling_userid IS NULL
        </if>
        <if test="isTakeSampling == 2">
            AND is_take_sampling = 1 AND take_sampling_userid = #{takeSamplingUserid}
        </if>
    </update>

    <select id="selectTakeNums" resultType="java.util.Map">
        SELECT
            (SELECT COUNT(1)
             FROM tb_sampling
             WHERE delete_flag = 0 AND take_sampling_modal = 1 AND is_take_sampling = 0 AND order_status = 2) AS takeNum1,
            IFNULL( sum( CASE is_take_sampling WHEN '1' THEN 1 ELSE 0 END ), 0 ) AS takeNum2,
            IFNULL( sum( CASE is_take_sampling WHEN '2' THEN 1 ELSE 0 END ), 0 ) AS takeNum3
        FROM
            tb_sampling
        WHERE
            delete_flag = 0
            AND take_sampling_modal = 1
            AND take_sampling_userid = #{userId}
    </select>

    <!--清空之前的报告费订单主表的printing_fee字段 shit-->
    <update id="emptyPrintingFee">
        UPDATE tb_sampling
        SET printing_fee = 0.0
        WHERE id = #{samplingId}
    </update>
    <update id="reviewSamplingBatch">
        update tb_sampling set review_signature=#{reviewName},approval_signature=#{approvalSignature},
        update_by=#{userId},update_date=now() where delete_flag=0 and id in
        <foreach collection="idas" item="ida" index="index" open="(" close=")" separator=",">
            #{ida}
        </foreach>
    </update>
    <select id="queryReCheck" resultMap="BaseResultMap" parameterType="Object">
        SELECT ts.id, ts.order_number, ts.ccu_name,ts.iu_name, ts.order_user_phone, ts.order_username,ts.order_time,
        ts.order_fees,SUM(IF(print_code_num is NULL, 1, 0)) collectNum
        FROM tb_sampling ts
        INNER JOIN tb_sampling_detail tsd ON ts.id = tsd.sampling_id
        WHERE ts.delete_flag = 0  AND ts.order_status =6
          <if test="startTime!=null and startTime!=''">
              AND ts.order_time &gt;= CONCAT(#{startTime},' 00:00:00')
          </if>
          <if test="endTime!=null and endTime!=''">
              AND ts.order_time &lt;= CONCAT(#{endTime},' 23:59:59')
          </if>
        GROUP BY ts.id
        ORDER BY ts.order_time DESC
    </select>
</mapper>